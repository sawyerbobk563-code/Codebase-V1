<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#171717">
    <title>NOTAM AI</title>
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" id="manifest-placeholder">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #171717;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #404040;
            --input-bg: #1a1a1a; /* Darker grey for input */
            --text-primary: #ececec;
            --text-secondary: #8b8b8b;
            --text-tertiary: #5a5a5a;
            --border-color: #404040;
            --accent-color: #ececec;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --cohere-color: #8b5cf6; /* Cohere purple */
            --cerebras-color: #00b4d8; /* Cerebras blue */
            --user-bubble: #3b82f6;
            --ai-bubble: #404040;
            --welcome-color: #f97316; /* Orange color */
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --bg-tertiary: #e5e7eb;
            --input-bg: #f9fafb; /* Lighter for light mode */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #d1d5db;
            --accent-color: #1f2937;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --cohere-color: #7c3aed; /* Darker purple for light mode */
            --cerebras-color: #0096c7; /* Darker Cerebras blue for light mode */
            --user-bubble: #3b82f6;
            --ai-bubble: #e5e7eb;
            --welcome-color: #ea580c; /* Darker orange for light mode */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Welcome message styling */
        .welcome-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            text-align: center;
            width: 90%;
            max-width: 600px;
            pointer-events: none;
        }

        .welcome-text {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--welcome-color);
            opacity: 1;
            transition: opacity 0.5s ease, transform 0.5s ease;
            text-shadow: 0 0 20px rgba(249, 115, 22, 0.7), 
                         0 0 40px rgba(249, 115, 22, 0.5),
                         0 0 60px rgba(249, 115, 22, 0.3);
            line-height: 1.2;
            letter-spacing: 1px;
            position: relative;
        }

        .welcome-text::after {
            content: '|';
            animation: blink 1s infinite;
            color: var(--welcome-color);
            position: absolute;
            right: -10px;
        }

        .welcome-text.fade-out {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--welcome-color);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        .welcome-text.done::after {
            display: none;
        }

        /* Glass blur effect when launchpad is open - Blur everything except launchpad */
        .blur-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 898;
            display: none;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.sidebar-open .blur-overlay {
            display: block;
            pointer-events: all;
        }

        /* Ensure launchpad stays above blur */
        .app-selector-sidebar {
            z-index: 899;
        }

        /* Smooth theme transition */
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Minimal scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Message bubbles - Updated for bubble style */
        .user-message {
            background: var(--user-bubble);
            color: white;
            border-radius: 18px 18px 4px 18px;
            padding: 12px 16px;
            margin: 8px 0;
            max-width: 85%;
            margin-left: auto;
            position: relative;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .ai-message {
            background: var(--ai-bubble);
            border-radius: 18px 18px 18px 4px;
            padding: 12px 16px;
            margin: 8px 0;
            max-width: 85%;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* AI message copy button */
        .ai-copy-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0;
            z-index: 10;
        }

        .ai-message:hover .ai-copy-btn {
            opacity: 1;
        }

        .ai-copy-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .ai-copy-btn.copied {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        /* Loading animation for AI response */
        .ai-loading {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 20px;
            margin: 4px 0;
            animation: pulse 2s infinite;
        }

        .ai-loading-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: loadingBounce 1.4s infinite ease-in-out;
        }

        .ai-loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dot:nth-child(2) { animation-delay: -0.16s; }
        .ai-loading-dot:nth-child(3) { animation-delay: 0s; }

        @keyframes loadingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Provider-specific styling */
        .cohere-model-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cohere-model-card:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: var(--cohere-color);
        }

        .cohere-model-card.selected {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--cohere-color);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }

        .cohere-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--cohere-color);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .cerebras-model-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cerebras-model-card:hover {
            background: rgba(0, 180, 216, 0.1);
            border-color: var(--cerebras-color);
        }

        .cerebras-model-card.selected {
            background: rgba(0, 180, 216, 0.15);
            border-color: var(--cerebras-color);
            box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.2);
        }

        .cerebras-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 180, 216, 0.2);
            color: var(--cerebras-color);
            border: 1px solid rgba(0, 180, 216, 0.3);
        }

        /* Code blocks */
        .code-block {
            background: var(--bg-secondary);
            border-radius: 8px;
            margin: 12px 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .code-header {
            background: var(--bg-tertiary);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .code-copy-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .code-copy-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .code-content {
            padding: 12px;
            overflow-x: auto;
        }

        /* Settings panel - Centered Modal with Animation */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            opacity: 0;
            overflow: hidden;
        }

        .settings-panel.active {
            display: flex;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .settings-panel.closing {
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 0;
        }

        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 999;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-overlay.closing {
            animation: fadeOut 0.3s ease;
            opacity: 0;
        }

        /* App Selector Sidebar - Compact Version */
        .app-selector-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100%;
            width: 220px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            z-index: 899;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .app-selector-sidebar.open {
            transform: translateX(0);
        }

        /* Smaller App Selector Toggle Button */
        .app-selector-toggle {
            position: fixed;
            left: 12px; /* Moved closer to edge */
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px; /* Reduced padding */
            border-radius: 6px; /* Slightly smaller radius */
            cursor: pointer;
            z-index: 901;
            transition: all 0.3s ease;
            width: 32px; /* Fixed width */
            height: 32px; /* Fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-selector-toggle:hover {
            background: var(--bg-tertiary);
            transform: translateY(-50%) scale(1.05);
        }

        .app-selector-toggle.open {
            left: 232px; /* Adjusted for new width */
        }

        /* Smaller icon inside toggle */
        .app-selector-toggle svg {
            width: 16px; /* Smaller icon */
            height: 16px;
        }

        /* App items with equal length */
        .app-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 4px 8px;
            border-radius: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            width: calc(100% - 16px);
            max-width: none;
        }

        .app-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .app-icon {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            border-radius: 6px;
            object-fit: contain;
            flex-shrink: 0;
        }

        .app-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            text-align: left;
        }

        .app-selector-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .app-selector-title {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .app-selector-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app-selector-footer {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .app-feedback {
            font-size: 10px;
            color: var(--text-tertiary);
            min-height: 16px;
        }

        /* Main content adjustment when sidebar is open */
        body.sidebar-open main {
            margin-left: 220px;
            transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 400px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            z-index: 1002;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            opacity: 0;
            overflow: hidden;
        }

        .login-modal.active {
            display: flex;
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .login-modal.closing {
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 0;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            z-index: 1001;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .login-overlay.active {
            display: block;
        }

        .login-overlay.closing {
            animation: fadeOut 0.3s ease;
            opacity: 0;
        }

        .login-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .login-content {
            padding: 24px;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg); /* Darker grey */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(139, 139, 139, 0.1);
        }

        .login-error {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Model selection */
        .model-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-secondary);
        }

        .model-card.selected {
            background: var(--bg-tertiary);
            border-color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(139, 139, 139, 0.2);
        }

        .model-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Token counter - Harsher and faster */
        .token-counter {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            color: var(--text-secondary);
            z-index: 100;
            display: none;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.15s ease;
        }

        .token-counter.active {
            display: block;
            animation: slideInUp 0.2s ease;
        }

        .token-counter.critical {
            animation: pulseCritical 0.5s infinite alternate;
            border-color: var(--error-color);
        }

        @keyframes pulseCritical {
            from { 
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
                border-color: var(--error-color);
            }
            to { 
                box-shadow: 0 0 0 4px rgba(239, 68, 68, 0);
                border-color: var(--error-color);
            }
        }

        .token-progress-container {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            margin: 8px 0;
            overflow: hidden;
        }

        .token-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 3px;
            transition: width 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .token-progress-bar.critical {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .token-progress-bar.warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .token-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        /* Quick persona buttons - with highlight and vertical scrolling */
        .quick-persona-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .quick-persona-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .quick-persona-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
            position: relative;
        }

        .quick-persona-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--success-color);
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: popIn 0.3s ease;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        @keyframes slideInUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Scroll to bottom button */
        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 90;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .scroll-to-bottom-btn.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .scroll-to-bottom-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .scroll-to-bottom-btn svg {
            width: 20px;
            height: 20px;
            color: var(--text-primary);
        }

        /* Theme switcher */
        .theme-switcher {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .theme-switcher::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        [data-theme="light"] .theme-switcher::before {
            transform: translateX(30px);
        }

        .theme-switcher svg {
            position: absolute;
            top: 5px;
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .theme-switcher .sun {
            left: 5px;
        }

        .theme-switcher .moon {
            right: 5px;
        }

        /* Save button animation */
        .save-button {
            position: relative;
            overflow: hidden;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .save-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .save-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        /* Settings header - Now non-sticky for scrolling */
        .settings-header {
            background: var(--bg-primary);
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
        }

        /* Settings content scrollable area - Improved organization */
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 24px; /* Consistent spacing between sections */
        }

        /* Settings sections */
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section-title svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        /* Quick personas vertical scrolling container */
        .quick-personas-container {
            overflow-y: auto;
            max-height: 120px; /* Fixed height for vertical scrolling */
            margin-bottom: 16px;
            padding-right: 8px;
        }

        .quick-personas-container::-webkit-scrollbar {
            width: 4px;
        }

        .quick-personas-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .quick-personas-container::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 2px;
        }

        /* Quick personas vertical layout */
        #quickPersonas {
            display: flex;
            flex-direction: column; /* Changed to vertical */
            gap: 8px;
        }

        /* Notification in top middle */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 90%;
            text-align: center;
        }

        .notification.success {
            background: var(--success-color);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .notification.error {
            background: var(--error-color);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .notification.warning {
            background: var(--warning-color);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Input focus */
        .focus-ring:focus {
            outline: none;
            border-color: var(--text-secondary);
            box-shadow: 0 0 0 3px rgba(139, 139, 139, 0.1);
        }

        /* Selection */
        ::selection {
            background: rgba(139, 139, 139, 0.3);
        }

        /* Loading animation for save button */
        .save-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Custom API Key Input */
        .custom-api-key-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }

        .custom-api-key-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .api-key-note {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-top: 4px;
            line-height: 1.4;
        }

        /* Token estimate display */
        .token-estimate-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .ai-token-estimate {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .ai-token-estimate.high {
            color: var(--warning-color);
        }

        .ai-token-estimate.critical {
            color: var(--error-color);
        }

        /* User input with darker grey */
        .user-input {
            background: var(--input-bg) !important; /* Darker grey */
            border: 1px solid var(--border-color) !important;
        }

        /* Settings navigation improvements */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .settings-grid-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .settings-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Better spacing for settings controls */
        .settings-control {
            margin-bottom: 20px;
        }

        .settings-control:last-child {
            margin-bottom: 0;
        }

        /* Improved slider styling */
        .settings-slider {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-primary);
        }

        .settings-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-primary);
        }
    </style>
</head>
<body class="h-screen flex flex-col theme-transition" data-theme="dark">
    <!-- Welcome Message -->
    <div id="welcomeContainer" class="welcome-container">
        <div class="welcome-text" id="welcomeText"></div>
    </div>

    <!-- Blur Overlay for Launchpad -->
    <div class="blur-overlay"></div>

    <!-- Login Modal -->
    <div id="loginOverlay" class="login-overlay" onclick="closeLoginModal()"></div>
    <div id="loginModal" class="login-modal theme-transition">
        <div class="login-header">
            <h2 class="text-xl font-semibold text-[var(--text-primary)]">Token Limit Reached</h2>
            <p class="text-sm text-[var(--text-secondary)] mt-2">Enter password to reset token counter</p>
        </div>
        <div class="login-content">
            <input type="password" id="loginPassword" class="login-input" placeholder="Enter password" autocomplete="off">
            <button onclick="checkPassword()" class="w-full px-4 py-3 bg-[var(--accent-color)] text-[var(--bg-primary)] rounded-lg font-medium hover:opacity-90 transition-all duration-200">
                Reset Token Counter
            </button>
            <div id="loginError" class="login-error">
                Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <!-- App Selector Toggle Button -->
    <button 
        id="appSelectorToggle"
        class="app-selector-toggle theme-transition"
        onclick="toggleAppSelector()"
        title="Toggle App Selector"
    >
        <svg id="appSelectorIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </button>

    <!-- App Selector Sidebar -->
    <div id="appSelectorSidebar" class="app-selector-sidebar theme-transition">
        <div class="app-selector-header">
            <h2 class="app-selector-title">Launchpad</h2>
        </div>

        <div class="app-selector-content">
            <!-- Safari -->
            <button onclick="launchApp('https://')" class="app-item theme-transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/52/Safari_browser_logo.svg" class="app-icon" alt="Safari">
                <span class="app-name">Safari</span>
            </button>

            <!-- Notability -->
            <button onclick="launchApp('notability://')" class="app-item theme-transition">
                <img src="https://raw.githubusercontent.com/notability/notability-assets/main/AppIcon.png" class="app-icon" alt="Notability">
                <span class="app-name">Notability</span>
            </button>

            <!-- Gmail -->
            <button onclick="launchApp('googlegmail://')" class="app-item theme-transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/7e/Gmail_icon_%282020%29.svg" class="app-icon" alt="Gmail">
                <span class="app-name">Gmail</span>
            </button>

            <!-- Google Tasks -->
            <button onclick="launchApp('googletasks://')" class="app-item theme-transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Google_Tasks_2021.svg" class="app-icon" alt="Google Tasks">
                <span class="app-name">Tasks</span>
            </button>

            <!-- Google Translate -->
            <button onclick="launchApp('googletranslate://')" class="app-item theme-transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d7/Google_Translate_logo.svg" class="app-icon" alt="Translate">
                <span class="app-name">Translate</span>
            </button>

            <!-- Schoology -->
            <button onclick="launchApp('schoology://')" class="app-item theme-transition">
                <img src="https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico" class="app-icon scale-125" alt="Schoology">
                <span class="app-name">Schoology</span>
            </button>

            <!-- Spotify -->
            <button onclick="launchApp('spotify://')" class="app-item theme-transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg" class="app-icon" alt="Spotify">
                <span class="app-name">Spotify</span>
            </button>

            <!-- Calculator -->
            <button onclick="launchApp('calculator://')" class="app-item theme-transition">
                <svg class="app-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                <span class="app-name">Calculator</span>
            </button>

            <!-- Calendar -->
            <button onclick="launchApp('calshow://')" class="app-item theme-transition">
                <svg class="app-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span class="app-name">Calendar</span>
            </button>

            <!-- Notes -->
            <button onclick="launchApp('mobilenotes://')" class="app-item theme-transition">
                <svg class="app-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                <span class="app-name">Notes</span>
            </button>

            <!-- NEW: Settings App -->
            <button onclick="openSettings()" class="app-item theme-transition">
                <svg class="app-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="app-name">Settings</span>
            </button>

            <!-- NEW: Files App -->
            <button onclick="launchApp('files://')" class="app-item theme-transition">
                <svg class="app-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span class="app-name">Files</span>
            </button>
        </div>

        <div class="app-selector-footer">
            <p id="appFeedback" class="app-feedback"></p>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay" onclick="closeSettings()"></div>

    <!-- Scroll to Bottom Button -->
    <div id="scrollToBottomBtn" class="scroll-to-bottom-btn" onclick="scrollToBottom()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
        </svg>
    </div>

    <!-- Token Counter -->
    <div id="tokenCounter" class="token-counter theme-transition">
        <div class="flex justify-between items-center mb-2">
            <div>
                <div class="text-xs font-medium text-[var(--text-primary)]">Token Usage</div>
                <div class="text-[10px] text-[var(--text-tertiary)]">Current Conversation</div>
            </div>
            <div class="text-right">
                <div id="tokenCount" class="text-sm font-mono font-medium">0/3200</div>
                <div id="aiTokenEstimateDisplay" class="text-[10px] text-[var(--text-tertiary)]">AI: ~0 tokens</div>
            </div>
        </div>
        <div class="token-progress-container">
            <div id="tokenProgressBar" class="token-progress-bar" style="width: 0%"></div>
        </div>
        <div class="flex justify-between items-center mt-2">
            <div class="text-xs text-[var(--text-tertiary)]" id="tokenEstimate">~0 words</div>
            <div class="text-xs" id="tokenPercentage">0%</div>
        </div>
    </div>

    <!-- Settings Panel - Centered Modal -->
    <div id="settingsPanel" class="settings-panel theme-transition">
        <div class="settings-header">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Settings</h2>
                <div class="flex items-center gap-3">
                    <!-- Theme Switcher -->
                    <div class="flex items-center gap-2">
                        <svg class="sun theme-switcher-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <div id="themeSwitcher" class="theme-switcher" onclick="toggleTheme()">
                            <svg class="sun" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            <svg class="moon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                        </div>
                        <svg class="moon theme-switcher-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </div>
                    
                    <button onclick="closeSettings()" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] p-2 rounded-lg hover:bg-[var(--bg-secondary)] theme-transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- API Provider Selection -->
            <div class="settings-control">
                <h3 class="text-sm font-medium mb-3 text-[var(--text-secondary)]">API Provider</h3>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <button id="providerOpenRouter" class="flex-1 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border border-[var(--border-color)] text-sm font-medium hover:bg-[var(--bg-tertiary)] transition-colors theme-transition min-w-[100px]">OpenRouter</button>
                    <button id="providerGroq" class="flex-1 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border border-[var(--border-color)] text-sm font-medium hover:bg-[var(--bg-tertiary)] transition-colors theme-transition min-w-[100px]">Groq</button>
                    <button id="providerMistral" class="flex-1 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border border-[var(--border-color)] text-sm font-medium hover:bg-[var(--bg-tertiary)] transition-colors theme-transition min-w-[100px]">Mistral</button>
                    <button id="providerCohere" class="flex-1 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border border-[var(--border-color)] text-sm font-medium hover:bg-[var(--bg-tertiary)] transition-colors theme-transition min-w-[100px]">Cohere</button>
                    <button id="providerCerebras" class="flex-1 px-4 py-2 rounded-lg bg-[var(--bg-secondary)] text-[var(--text-primary)] border border-[var(--border-color)] text-sm font-medium hover:bg-[var(--bg-tertiary)] transition-colors theme-transition min-w-[100px]">Cerebras</button>
                </div>
                <div id="apiStatus" class="flex items-center gap-2 mt-3 text-sm text-[var(--text-secondary)]">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span id="apiStatusText">Groq: Connected (FREE)</span>
                </div>
            </div>

            <!-- Quick Personas - Now with vertical scrolling -->
            <div class="settings-control">
                <h3 class="text-sm font-medium mb-2 text-[var(--text-secondary)]">Quick Personas</h3>
                <div class="quick-personas-container">
                    <div class="flex flex-col gap-2" id="quickPersonas">
                        <!-- Persona buttons will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-content">
            <!-- AI Configuration Section -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    AI Configuration
                </div>
                
                <!-- AI Model Selection -->
                <div class="settings-control">
                    <h3 class="text-sm font-medium mb-3 text-[var(--text-secondary)]">AI Model</h3>
                    <div class="space-y-2" id="modelSelection">
                        <!-- Models will be populated here -->
                    </div>
                </div>

                <!-- System Prompt -->
                <div class="settings-control">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-medium text-[var(--text-secondary)]">System Prompt</label>
                        <span class="text-xs text-[var(--text-tertiary)]">Tokens: <span id="promptTokens">0</span></span>
                    </div>
                    <textarea id="systemPrompt" rows="4" 
                        class="w-full px-3 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring resize-none theme-transition"
                        oninput="updateTokenCount()"></textarea>
                    <p class="text-xs mt-1 text-[var(--text-tertiary)]">Customize how the AI behaves</p>
                </div>

                <!-- Temperature & Max Tokens Grid -->
                <div class="settings-grid">
                    <div class="settings-grid-item">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Temperature</label>
                            <span class="text-xs text-[var(--text-secondary)]" id="tempValue">0.7</span>
                        </div>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" 
                               class="settings-slider theme-transition">
                        <p class="text-xs mt-1 text-[var(--text-tertiary)]">Creativity</p>
                    </div>
                    
                    <div class="settings-grid-item">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-sm font-medium text-[var(--text-secondary)]">Max Response Length</label>
                            <span class="text-xs text-[var(--text-secondary)]" id="tokenValue">3200 tokens</span>
                        </div>
                        <input type="range" id="maxTokens" min="128" max="32768" step="128" value="3200"
                               class="settings-slider theme-transition">
                        <div class="token-estimate-display">
                            <span>~<span id="wordEstimate">2461</span> words</span>
                            <span id="aiTokenEstimate" class="ai-token-estimate">AI: ~0 tokens</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Keys Section -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                    API Keys
                </div>

                <!-- Custom API Key Sections -->
                <div id="openRouterApiKeySection" class="custom-api-key-section hidden">
                    <h3 class="text-sm font-medium mb-2 text-[var(--text-primary)]">OpenRouter API Key</h3>
                    <input type="password" id="openRouterApiKey" 
                           class="w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition"
                           placeholder="sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                    <p class="api-key-note">Optional. Get your key from <a href="https://openrouter.ai/keys" target="_blank" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] underline">openrouter.ai/keys</a></p>
                </div>

                <div id="groqApiKeySection" class="custom-api-key-section hidden">
                    <h3 class="text-sm font-medium mb-2 text-[var(--text-primary)]">Groq API Key</h3>
                    <input type="password" id="groqApiKey" 
                           class="w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition"
                           placeholder="gsk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                    <p class="api-key-note">Optional. Get your key from <a href="https://console.groq.com/keys" target="_blank" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] underline">console.groq.com</a></p>
                </div>

                <div id="mistralApiKeySection" class="custom-api-key-section hidden">
                    <h3 class="text-sm font-medium mb-2 text-[var(--text-primary)]">Mistral API Key</h3>
                    <input type="password" id="mistralApiKey" 
                           class="w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition"
                           placeholder="sk-...">
                    <p class="api-key-note">Optional. Default public key will be used if empty.</p>
                </div>

                <div id="cohereApiKeySection" class="custom-api-key-section hidden">
                    <h3 class="text-sm font-medium mb-2 text-[var(--text-primary)]">Cohere API Key</h3>
                    <input type="password" id="cohereApiKey" 
                           class="w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition"
                           placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                    <p class="api-key-note">Required. Get from <a href="https://dashboard.cohere.com/api-keys" target="_blank" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] underline">dashboard.cohere.com</a></p>
                </div>

                <div id="cerebrasApiKeySection" class="custom-api-key-section hidden">
                    <h3 class="text-sm font-medium mb-2 text-[var(--text-primary)]">Cerebras API Key</h3>
                    <input type="password" id="cerebrasApiKey" 
                           class="w-full px-3 py-2 bg-[var(--bg-tertiary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition"
                           placeholder="csk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                    <p class="api-key-note">Required. Get from <a href="https://cerebras.ai" target="_blank" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] underline">cerebras.ai</a></p>
                </div>
            </div>

            <!-- Rate Limiting Section -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    Rate Limiting
                </div>
                
                <div class="settings-grid">
                    <div class="settings-grid-item">
                        <label class="block text-xs mb-1 text-[var(--text-secondary)]">Requests per minute</label>
                        <input type="number" id="rateLimit" min="1" max="60" value="30" 
                               class="w-full px-3 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition">
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-3">
                    <input type="checkbox" id="enableRateLimit" checked 
                           class="w-4 h-4 rounded border-[var(--border-color)] bg-[var(--bg-secondary)] focus:ring-0 theme-transition">
                    <label class="text-sm text-[var(--text-secondary)]">Enable rate limiting</label>
                </div>
            </div>

            <!-- Chat Management Section -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                    </svg>
                    Chat Management
                </div>
                
                <!-- Search Chat -->
                <div class="settings-control">
                    <label class="block text-sm font-medium mb-2 text-[var(--text-secondary)]">Search Chat</label>
                    <input type="text" id="searchChat" placeholder="Search messages..."
                           class="w-full px-3 py-2 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg text-sm focus-ring theme-transition">
                </div>

                <!-- Chat History Actions -->
                <div class="settings-grid">
                    <button onclick="clearHistory()" class="px-3 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] border border-[var(--border-color)] text-sm rounded-lg transition-colors theme-transition">Clear History</button>
                    <button onclick="exportHistory()" class="px-3 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] border border-[var(--border-color)] text-sm rounded-lg transition-colors theme-transition">Export Chat</button>
                    <button onclick="importHistory()" class="px-3 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] border border-[var(--border-color)] text-sm rounded-lg transition-colors theme-transition">Import Chat</button>
                    <button onclick="restoreLastChat()" class="px-3 py-2 bg-[var(--bg-secondary)] hover:bg-[var(--bg-tertiary)] border border-[var(--border-color)] text-sm rounded-lg transition-colors theme-transition">Restore Last</button>
                    <input type="file" id="importFile" accept=".json,.txt" class="hidden">
                </div>
            </div>

            <!-- Interface Settings -->
            <div class="settings-section">
                <div class="settings-section-title">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Interface
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="showTokenCounter" 
                           class="w-4 h-4 rounded border-[var(--border-color)] bg-[var(--bg-secondary)] focus:ring-0 theme-transition">
                    <label class="text-sm text-[var(--text-secondary)]">Show token counter</label>
                </div>
            </div>
        </div>

        <div class="p-6 border-t border-[var(--border-color)] bg-[var(--bg-primary)] sticky bottom-0">
            <button onclick="saveSettings()" id="saveSettingsBtn" class="w-full px-4 py-3 bg-[var(--accent-color)] text-[var(--bg-primary)] rounded-lg font-medium hover:opacity-90 transition-all duration-200 save-button">
                Save Settings
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <main class="flex-1 flex flex-col max-w-4xl mx-auto w-full h-full transition-all duration-400">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-[var(--border-color)] theme-transition">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--accent-color)] to-[var(--text-secondary)] flex items-center justify-center">
                    <svg class="w-4 h-4 text-[var(--bg-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-medium">NOTAM AI</h1>
                    <div class="flex items-center gap-2">
                        <span id="modelBadge" class="text-xs px-2 py-0.5 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded theme-transition">Groq</span>
                        <span id="providerDisplay" class="text-xs text-[var(--text-tertiary)]">Llama 3.3 70B</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="toggleTokenCounter()" id="tokenToggleBtn" class="p-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded-lg transition-colors theme-transition" title="Toggle Token Counter">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                
                <button onclick="openSettings()" class="p-2 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-secondary)] rounded-lg transition-colors theme-transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chat-window" class="flex-1 overflow-y-auto p-4" onscroll="handleChatScroll()">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="border-t border-[var(--border-color)] p-4 theme-transition">
            <div class="relative">
                <div class="flex gap-2">
                    <input type="text" id="userInput" 
                        placeholder="Message NOTAM AI..." 
                        class="flex-1 px-4 py-3 user-input rounded-lg text-sm focus-ring theme-transition"
                        autocomplete="off"
                        onkeypress="if(event.key==='Enter') sendMessage()"
                        oninput="updateInputTokenCount()">
                    
                    <button onclick="sendMessage()" id="sendBtn"
                        class="px-4 bg-[var(--accent-color)] text-[var(--bg-primary)] rounded-lg font-medium hover:opacity-90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                        <span>Send</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <div id="inputTokenCounter" class="text-xs text-[var(--text-tertiary)] hidden">
                        Input Tokens: <span id="inputTokenCount">0</span>
                    </div>
                    <div id="rateLimitInfo" class="text-xs text-[var(--text-tertiary)]">
                        <span id="requestCount">0</span>/<span id="rateLimitMax">30</span> requests/min
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG & STATE
        // ============================================
        const OPENROUTER_API_KEY = "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";
        const OPENROUTER_REFERRER = "https://notam-ai.netlify.app";
        
        const GROQ_API_KEY = "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";
        
        const DEFAULT_MISTRAL_KEY = 'FT03yFBEWRjW1sfGOnmqdmGSdiqw2KFs';
        const DEFAULT_MISTRAL_AGENT = 'ag_019bfb7cb7597665b81f3f2418b755cd';
        
        const DEFAULT_COHERE_KEY = "50aeq2Klv2cuSBwLzW4jscqdVjReZHgusOqLTcSU";
        
        const DEFAULT_CEREBRAS_KEY = "csk-9pte623nnjtythw9228dj3pnedr2ck49j83ykxdmyyxwy88w";
        const CEREBRAS_API_URL = "https://api.cerebras.ai/v1/chat/completions";
        
        // Local storage keys
        const CHAT_HISTORY_KEY = 'notam_chat_history';
        const SETTINGS_KEY = 'notam_settings';
        const MISTRAL_KEY_KEY = 'mistral_key';
        const MISTRAL_AGENT_KEY = 'mistral_agent_id';
        const OPENROUTER_KEY_KEY = 'openrouter_key';
        const GROQ_KEY_KEY = 'groq_key';
        const COHERE_KEY_KEY = 'cohere_key';
        const CEREBRAS_KEY_KEY = 'cerebras_key';
        const THEME_KEY = 'notam_theme';
        const TOKEN_RESET_KEY = 'notam_token_reset';
        const TOTAL_TOKENS_KEY = 'notam_total_tokens';
        const LAST_CHAT_BACKUP_KEY = 'notam_last_chat_backup';
        
        // Token limits
        const DAILY_TOKEN_LIMIT = 3200;
        const PASSWORD = "Admin";
        
        const API_PROVIDERS = {
            OPENROUTER: 'openrouter',
            GROQ: 'groq',
            MISTRAL: 'mistral',
            COHERE: 'cohere',
            CEREBRAS: 'cerebras'
        };
        
        // Models configuration
        const OPENROUTER_MODELS = [
            {
                id: "openai/gpt-4o-mini",
                name: "GPT-4o Mini",
                provider: "OpenAI",
                description: "Fast and capable, OpenAI's best small model",
                maxTokens: 16384,
                badge: "OPENAI",
                costPerMTok: 0.15,
                recommended: true
            },
            {
                id: "meta-llama/llama-3.3-70b-instruct",
                name: "Llama 3.3 70B",
                provider: "Meta",
                description: "Most capable open-source model",
                maxTokens: 8192,
                badge: "POWER",
                costPerMTok: 0.59
            },
            {
                id: "google/gemma-2-9b-it",
                name: "Gemma 2 9B",
                provider: "Google",
                description: "Google's lightweight but capable model",
                maxTokens: 8192,
                badge: "GOOGLE",
                costPerMTok: 0.09,
                recommended: true
            },
            {
                id: "mistralai/mixtral-8x7b-instruct",
                name: "Mixtral 8x7B",
                provider: "Mistral",
                description: "Mixture of experts, excellent for coding",
                maxTokens: 32768,
                badge: "MISTRAL",
                costPerMTok: 0.24
            },
            {
                id: "deepseek/deepseek-chat",
                name: "DeepSeek Chat",
                provider: "DeepSeek",
                description: "Excellent coding and reasoning",
                maxTokens: 32768,
                badge: "DEEPSEEK",
                costPerMTok: 0.14
            },
            {
                id: "qwen/qwen-2.5-72b-instruct",
                name: "Qwen 2.5 72B",
                provider: "Alibaba",
                description: "Powerful Chinese/English model",
                maxTokens: 32768,
                badge: "QWEN",
                costPerMTok: 0.79
            }
        ];

        const GROQ_MODELS = [
            {
                id: "llama-3.3-70b-versatile",
                name: "Llama 3.3 70B",
                provider: "Groq",
                description: "Super fast Llama model (FREE)",
                maxTokens: 8192,
                badge: "SPEED",
                free: true,
                recommended: true
            },
            {
                id: "llama-3.2-90b-text-preview",
                name: "Llama 3.2 90B",
                provider: "Groq",
                description: "Extremely powerful for advanced reasoning",
                maxTokens: 8192,
                badge: "POWER",
                free: true
            },
            {
                id: "llama-3.1-8b-instant",
                name: "Llama 3.1 8B",
                provider: "Groq",
                description: "Fast and efficient for everyday tasks",
                maxTokens: 8192,
                badge: "FAST",
                free: true
            },
            {
                id: "openai/gpt-oss-120b",
                name: "GPT OSS 120B",
                provider: "Groq",
                description: "Massive 120B parameter open-source GPT",
                maxTokens: 8192,
                badge: "MASSIVE",
                free: true
            },
            {
                id: "qwen/qwen3-32b",
                name: "Qwen3 32B",
                provider: "Groq",
                description: "Powerful Qwen model, great for multilingual",
                maxTokens: 8192,
                badge: "QWEN",
                free: true
            },
            {
                id: "llama-3.2-3b-preview",
                name: "Llama 3.2 3B",
                provider: "Groq",
                description: "Ultra-fast for quick responses",
                maxTokens: 4096,
                badge: "ULTRA",
                free: true
            }
        ];

        const MISTRAL_MODELS = [
            {
                id: "agent",
                name: "Custom Agent",
                provider: "Mistral",
                description: "Custom Mistral Agent with advanced capabilities",
                maxTokens: 32768,
                badge: "AGENT",
                requiresAgentId: true
            },
            {
                id: "mistral-large-latest",
                name: "Mistral Large",
                provider: "Mistral",
                description: "Most capable Mistral model",
                maxTokens: 32768,
                badge: "POWER",
                recommended: true
            },
            {
                id: "mistral-medium-latest",
                name: "Mistral Medium",
                provider: "Mistral",
                description: "Balanced performance and speed",
                maxTokens: 32768,
                badge: "BALANCED"
            },
            {
                id: "mistral-small-latest",
                name: "Mistral Small",
                provider: "Mistral",
                description: "Fast and efficient",
                maxTokens: 32768,
                badge: "FAST"
            },
            {
                id: "open-mistral-7b",
                name: "Mistral 7B",
                provider: "Mistral",
                description: "Lightweight open model",
                maxTokens: 32768,
                badge: "LIGHT"
            },
            {
                id: "open-mixtral-8x7b",
                name: "Mixtral 8x7B",
                provider: "Mistral",
                description: "Mixture of 8 experts model",
                maxTokens: 32768,
                badge: "MIXTURE"
            }
        ];

        const COHERE_MODELS = [
            {
                id: "command-a-03-2025",
                name: "Command A",
                provider: "Cohere",
                description: "Most capable Cohere model (Best Overall)",
                maxTokens: 4096,
                badge: "BEST",
                recommended: true
            },
            {
                id: "command-r-plus-08-2024",
                name: "Command R+",
                provider: "Cohere",
                description: "Excellent for complex reasoning tasks",
                maxTokens: 4096,
                badge: "REASONING"
            },
            {
                id: "command-r-08-2024",
                name: "Command R",
                provider: "Cohere",
                description: "General purpose model (Default)",
                maxTokens: 4096,
                badge: "GENERAL"
            },
            {
                id: "command-r7b-12-2024",
                name: "Command R7B",
                provider: "Cohere",
                description: "Fast and efficient 7B parameter model",
                maxTokens: 4096,
                badge: "FAST"
            }
        ];

        const CEREBRAS_MODELS = [
            {
                id: "zai-glm-4.7",
                name: "Zai GLM 4.7",
                provider: "Cerebras",
                description: "Powerful multilingual model optimized for Cerebras hardware",
                maxTokens: 65000,
                badge: "POWER",
                recommended: true
            },
            {
                id: "llama3.1-8b",
                name: "Llama 3.1 8B",
                provider: "Cerebras",
                description: "Fast and efficient Llama model on Cerebras",
                maxTokens: 65000,
                badge: "FAST"
            },
            {
                id: "llama3.1-70b",
                name: "Llama 3.1 70B",
                provider: "Cerebras",
                description: "High-performance 70B parameter model",
                maxTokens: 65000,
                badge: "SPEED"
            }
        ];
        
        // Personas
        const QUICK_PERSONAS = [
            {
                id: "default",
                name: "Default",
                prompt: "You are NOTAM AI. You are a high-performance, unfiltered-style intelligence. You speak directly, concisely, and efficiently. You do not use fluff words. You use bullet points and bold text for clarity. You are extremely helpful and knowledgeable. Warning: User is a minor, so strictly maintain safety protocols (no illegal acts, violence, or explicit content), but maintain the 'unfiltered' persona by being blunt and direct."
            },
            {
                id: "coder",
                name: "Coder",
                prompt: "You are a senior software engineer. Write clean, efficient code with best practices. Explain technical concepts clearly. Focus on practical solutions and performance."
            },
            {
                id: "creative",
                name: "Creative",
                prompt: "You are a creative writer. Be imaginative, descriptive, and help with brainstorming. Use engaging language and explore ideas creatively."
            },
            {
                id: "analyst",
                name: "Analyst",
                prompt: "You are a data analyst. Be logical, systematic, and data-driven. Use bullet points and structured reasoning. Focus on facts and evidence."
            },
            {
                id: "teacher",
                name: "Teacher",
                prompt: "You are a patient teacher. Explain complex topics simply. Use analogies and examples. Check for understanding and adapt to user's level."
            },
            {
                id: "minimal",
                name: "Minimal",
                prompt: "You are a minimal assistant. Give the shortest possible answers with all necessary information. No fluff. Just facts. Maximum efficiency."
            }
        ];
        
        // Global state
        let requestTimestamps = [];
        let totalConversationTokens = 0;
        let lastAiResponseTokens = 0;
        let dailyTokenUsage = 0;
        let appSelectorOpen = false;
        let hasUserSentMessage = false;
        
        // Settings
        let settings = {
            systemPrompt: "You are NOTAM AI. You are a high-performance, unfiltered-style intelligence. You speak directly, concisely, and efficiently. You do not use fluff words. You use bullet points and bold text for clarity. You are extremely helpful and knowledgeable. Warning: User is a minor, so strictly maintain safety protocols (no illegal acts, violence, or explicit content), but maintain the 'unfiltered' persona by being blunt and direct.",
            temperature: 0.7,
            maxTokens: 3200,
            rateLimit: 30,
            enableRateLimit: true,
            selectedModel: "llama-3.3-70b-versatile",
            selectedProvider: API_PROVIDERS.GROQ,
            showTokenCounter: false,
            selectedPersona: "default",
            mistralApiKey: localStorage.getItem(MISTRAL_KEY_KEY) || DEFAULT_MISTRAL_KEY,
            mistralAgentId: localStorage.getItem(MISTRAL_AGENT_KEY) || DEFAULT_MISTRAL_AGENT,
            openRouterApiKey: localStorage.getItem(OPENROUTER_KEY_KEY) || OPENROUTER_API_KEY,
            groqApiKey: localStorage.getItem(GROQ_KEY_KEY) || GROQ_API_KEY,
            cohereApiKey: localStorage.getItem(COHERE_KEY_KEY) || DEFAULT_COHERE_KEY,
            cerebrasApiKey: localStorage.getItem(CEREBRAS_KEY_KEY) || DEFAULT_CEREBRAS_KEY,
            theme: localStorage.getItem(THEME_KEY) || 'dark'
        };

        // --- PWA & MANIFEST ---
        function initPWA() {
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#171717"/><circle cx="256" cy="256" r="150" fill="#ececec"/><circle cx="256" cy="256" r="80" fill="#171717"/></svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);

            const manifest = {
                name: "NOTAM AI",
                short_name: "NOTAM",
                start_url: ".",
                display: "standalone",
                background_color: "#171717",
                theme_color: "#171717",
                icons: [{ src: iconUrl, sizes: "512x512", type: "image/svg+xml" }]
            };
            
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
        }
        initPWA();

        // --- INSTALL PROMPT ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        // --- WELCOME MESSAGE ---
        function typeWelcomeMessage() {
            const welcomeText = document.getElementById('welcomeText');
            const container = document.getElementById('welcomeContainer');
            
            if (!welcomeText) return;
            
            const finalText = "Welcome CCC";
            let currentIndex = 0;
            const typingSpeed = 100; // ms per character
            
            welcomeText.textContent = "";
            container.style.display = 'block';
            
            const typingInterval = setInterval(() => {
                if (currentIndex < finalText.length) {
                    welcomeText.textContent += finalText.charAt(currentIndex);
                    currentIndex++;
                } else {
                    clearInterval(typingInterval);
                    welcomeText.classList.add('done');
                    
                    // Start fade out after 2 seconds
                    setTimeout(() => {
                        fadeOutWelcomeMessage();
                    }, 2000);
                }
            }, typingSpeed);
        }

        function fadeOutWelcomeMessage() {
            const welcomeText = document.getElementById('welcomeText');
            const container = document.getElementById('welcomeContainer');
            
            if (welcomeText) {
                welcomeText.classList.add('fade-out');
            }
            
            // Remove after animation
            setTimeout(() => {
                if (container) {
                    container.style.display = 'none';
                }
            }, 500);
        }

        function checkWelcomeMessage() {
            const chatWindow = document.getElementById('chat-window');
            const messages = chatWindow.querySelectorAll('.message-container');
            
            if (messages.length === 0) {
                const container = document.getElementById('welcomeContainer');
                if (container) {
                    container.style.display = 'block';
                    const welcomeText = document.getElementById('welcomeText');
                    if (welcomeText) {
                        welcomeText.classList.remove('fade-out');
                        welcomeText.classList.remove('done');
                        welcomeText.textContent = "Welcome CCC";
                    }
                }
            }
        }

        // --- BACKUP LAST CHAT ---
        function backupLastChat() {
            const currentHistory = localStorage.getItem(CHAT_HISTORY_KEY);
            if (currentHistory) {
                localStorage.setItem(LAST_CHAT_BACKUP_KEY, currentHistory);
            }
        }

        function restoreLastChat() {
            const backup = localStorage.getItem(LAST_CHAT_BACKUP_KEY);
            if (!backup) {
                showNotification('No backup found to restore', true);
                return;
            }
            
            if (confirm('This will replace your current chat with the last saved backup. Continue?')) {
                // Backup current chat first
                backupLastChat();
                
                // Restore from backup
                localStorage.setItem(CHAT_HISTORY_KEY, backup);
                
                // Clear current chat display
                document.getElementById('chat-window').innerHTML = '';
                
                // Reset token counters
                totalConversationTokens = 0;
                lastAiResponseTokens = 0;
                hasUserSentMessage = true;
                
                // Load restored history
                loadChatHistory();
                
                showNotification('Last chat restored successfully');
                
                // Hide welcome message
                fadeOutWelcomeMessage();
            }
        }

        // --- TOKEN LIMIT MANAGEMENT ---
        function checkTokenReset() {
            const lastReset = localStorage.getItem(TOKEN_RESET_KEY);
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;
            
            if (!lastReset || (now - parseInt(lastReset)) > twentyFourHours) {
                // Reset daily token usage
                dailyTokenUsage = 0;
                localStorage.setItem(TOTAL_TOKENS_KEY, '0');
                localStorage.setItem(TOKEN_RESET_KEY, now.toString());
                console.log('Token counter reset after 24 hours');
            } else {
                // Load existing daily token usage
                dailyTokenUsage = parseInt(localStorage.getItem(TOTAL_TOKENS_KEY) || '0');
            }
            
            // Check if limit is reached
            if (dailyTokenUsage >= DAILY_TOKEN_LIMIT) {
                showTokenLimitNotification();
            }
        }

        function updateDailyTokenUsage(tokens) {
            dailyTokenUsage += tokens;
            localStorage.setItem(TOTAL_TOKENS_KEY, dailyTokenUsage.toString());
            
            // Check if limit is reached
            if (dailyTokenUsage >= DAILY_TOKEN_LIMIT) {
                showTokenLimitNotification();
            }
        }

        function showTokenLimitNotification() {
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
                <span>Daily limit reached (${dailyTokenUsage}/${DAILY_TOKEN_LIMIT}). Click to reset.</span>
            `;
            
            notification.onclick = () => {
                openLoginModal();
                notification.remove();
            };
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideUp 0.3s ease-out';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) notification.remove();
                    }, 300);
                }
            }, 10000);
        }

        // --- NOTIFICATION FUNCTION (Updated for top middle) ---
        function showNotification(message, isError = false, isWarning = false) {
            // Remove any existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : isWarning ? 'warning' : 'success'}`;
            notification.innerHTML = `
                ${isError ? 
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' :
                isWarning ?
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.998-.833-2.732 0L4.732 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' :
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
                }
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideUp 0.3s ease-out';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentNode) notification.remove();
                    }, 300);
                }
            }, 3000);
        }

        // --- LOGIN MODAL FUNCTIONS ---
        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('loginPassword').focus();
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            const overlay = document.getElementById('loginOverlay');
            
            modal.classList.add('closing');
            overlay.classList.add('closing');
            
            setTimeout(() => {
                modal.classList.remove('active');
                modal.classList.remove('closing');
                overlay.classList.remove('active');
                overlay.classList.remove('closing');
                document.getElementById('loginError').classList.remove('show');
                document.getElementById('loginPassword').value = '';
            }, 300);
        }

        function checkPassword() {
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');
            
            if (password === PASSWORD) {
                // Reset token counter
                dailyTokenUsage = 0;
                localStorage.setItem(TOTAL_TOKENS_KEY, '0');
                localStorage.setItem(TOKEN_RESET_KEY, Date.now().toString());
                
                // Show success notification
                showNotification('Token counter reset successfully!');
                
                // Close modal
                closeLoginModal();
                
                // Update UI
                updateTokenCounterDisplay();
            } else {
                errorElement.classList.add('show');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        // --- APP SELECTOR FUNCTIONALITY ---
        function toggleAppSelector() {
            const sidebar = document.getElementById('appSelectorSidebar');
            const toggleBtn = document.getElementById('appSelectorToggle');
            const icon = document.getElementById('appSelectorIcon');
            
            appSelectorOpen = !appSelectorOpen;
            
            if (appSelectorOpen) {
                sidebar.classList.add('open');
                toggleBtn.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
                document.body.classList.add('sidebar-open');
            } else {
                sidebar.classList.remove('open');
                toggleBtn.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
                document.body.classList.remove('sidebar-open');
            }
        }

        function launchApp(uri) {
            const feedback = document.getElementById('appFeedback');
            
            // Special handling for Settings app
            if (uri === 'settings://') {
                openSettings();
                feedback.textContent = "Opening Settings...";
                setTimeout(() => {
                    feedback.textContent = "";
                }, 2000);
                return;
            }
            
            // Special handling for Files app
            if (uri === 'files://') {
                // Create a file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.multiple = true;
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);
                
                fileInput.onchange = function(e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        feedback.textContent = `${files.length} file(s) selected`;
                    }
                    setTimeout(() => {
                        feedback.textContent = "";
                    }, 3000);
                    document.body.removeChild(fileInput);
                };
                
                fileInput.click();
                feedback.textContent = "Opening Files...";
                return;
            }
            
            feedback.textContent = "Launching...";
            
            // Try to open the app URI
            window.location.href = uri;
            
            // Fallback after 2 seconds
            setTimeout(() => {
                feedback.textContent = "App not found or opened in new tab";
                setTimeout(() => {
                    feedback.textContent = "";
                }, 2000);
            }, 2000);
        }

        // --- THEME MANAGEMENT ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            settings.theme = newTheme;
            localStorage.setItem(THEME_KEY, newTheme);
            
            updateThemeSwitcherIcons();
            
            showNotification(`${newTheme === 'dark' ? 'Dark' : 'Light'} mode enabled`);
        }

        function updateThemeSwitcherIcons() {
            const themeIcons = document.querySelectorAll('.theme-switcher-icon');
            themeIcons.forEach(icon => {
                if (icon.classList.contains('sun')) {
                    icon.style.opacity = settings.theme === 'dark' ? '0.5' : '1';
                } else {
                    icon.style.opacity = settings.theme === 'light' ? '0.5' : '1';
                }
            });
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', settings.theme);
            updateThemeSwitcherIcons();
        }

        // --- AI MESSAGE COPY BUTTON ---
        function addCopyButtonToAIMessage(messageDiv) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'ai-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.title = 'Copy AI response';
            copyBtn.onclick = function(e) {
                e.stopPropagation();
                copyAIMessage(this);
            };
            
            messageDiv.appendChild(copyBtn);
        }

        function copyAIMessage(button) {
            const messageDiv = button.closest('.ai-message');
            const contentDiv = messageDiv.querySelector('.message-content');
            
            // Get the text content, stripping HTML tags but preserving markdown formatting
            let textToCopy = '';
            
            // Try to get text from code blocks first
            const codeBlocks = contentDiv.querySelectorAll('pre code');
            if (codeBlocks.length > 0) {
                textToCopy = codeBlocks[codeBlocks.length - 1].textContent;
            } else {
                // Fall back to all text content
                textToCopy = contentDiv.textContent || contentDiv.innerText;
            }
            
            // Clean up the text
            textToCopy = textToCopy.trim();
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Visual feedback
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
                
                showNotification('AI response copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy text', true);
            });
        }

        // --- SCROLL TO BOTTOM FUNCTIONALITY ---
        function handleChatScroll() {
            const chatWindow = document.getElementById('chat-window');
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            
            const isAtBottom = chatWindow.scrollHeight - chatWindow.clientHeight <= chatWindow.scrollTop + 100;
            
            if (isAtBottom) {
                scrollBtn.classList.remove('visible');
            } else {
                scrollBtn.classList.add('visible');
            }
        }

        function scrollToBottom() {
            const chatWindow = document.getElementById('chat-window');
            chatWindow.scrollTo({
                top: chatWindow.scrollHeight,
                behavior: 'smooth'
            });
        }

        // --- SETTINGS MANAGEMENT WITH ANIMATION ---
        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const loadedSettings = JSON.parse(saved);
                settings = { ...settings, ...loadedSettings };
                
                // Apply theme first
                applyTheme();
                
                // Update UI
                document.getElementById('systemPrompt').value = settings.systemPrompt;
                document.getElementById('temperature').value = settings.temperature;
                document.getElementById('tempValue').textContent = settings.temperature;
                document.getElementById('maxTokens').value = settings.maxTokens;
                document.getElementById('tokenValue').textContent = `${settings.maxTokens} tokens`;
                document.getElementById('rateLimit').value = settings.rateLimit;
                document.getElementById('enableRateLimit').checked = settings.enableRateLimit;
                document.getElementById('showTokenCounter').checked = settings.showTokenCounter;
                document.getElementById('mistralApiKey').value = settings.mistralApiKey;
                document.getElementById('openRouterApiKey').value = settings.openRouterApiKey;
                document.getElementById('groqApiKey').value = settings.groqApiKey;
                document.getElementById('cohereApiKey').value = settings.cohereApiKey;
                document.getElementById('cerebrasApiKey').value = settings.cerebrasApiKey;
                
                // Update provider selection
                updateProviderUI();
                loadModelSelection();
                loadQuickPersonas();
                updateModelBadge();
                
                // Update token counter visibility
                if (settings.showTokenCounter) {
                    document.getElementById('tokenCounter').classList.add('active');
                }
                
                updateRateLimitDisplay();
                updateWordEstimate();
                updateTokenCount();
                updateAiTokenEstimate();
            }
        }

        function saveSettings() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            const originalText = saveBtn.innerHTML;
            
            // Show loading state
            saveBtn.innerHTML = '<div class="save-loading"></div>';
            saveBtn.disabled = true;
            
            // Update settings
            settings.systemPrompt = document.getElementById('systemPrompt').value;
            settings.temperature = parseFloat(document.getElementById('temperature').value);
            settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            settings.rateLimit = parseInt(document.getElementById('rateLimit').value);
            settings.enableRateLimit = document.getElementById('enableRateLimit').checked;
            settings.showTokenCounter = document.getElementById('showTokenCounter').checked;
            settings.mistralApiKey = document.getElementById('mistralApiKey').value || DEFAULT_MISTRAL_KEY;
            settings.openRouterApiKey = document.getElementById('openRouterApiKey').value || OPENROUTER_API_KEY;
            settings.groqApiKey = document.getElementById('groqApiKey').value || GROQ_API_KEY;
            settings.cohereApiKey = document.getElementById('cohereApiKey').value || DEFAULT_COHERE_KEY;
            settings.cerebrasApiKey = document.getElementById('cerebrasApiKey').value || DEFAULT_CEREBRAS_KEY;
            
            // Save to localStorage
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            localStorage.setItem(MISTRAL_KEY_KEY, settings.mistralApiKey);
            localStorage.setItem(OPENROUTER_KEY_KEY, settings.openRouterApiKey);
            localStorage.setItem(GROQ_KEY_KEY, settings.groqApiKey);
            localStorage.setItem(COHERE_KEY_KEY, settings.cohereApiKey);
            localStorage.setItem(CEREBRAS_KEY_KEY, settings.cerebrasApiKey);
            localStorage.setItem(THEME_KEY, settings.theme);
            
            // Add visual feedback
            saveBtn.style.backgroundColor = 'var(--success-color)';
            saveBtn.style.color = 'white';
            
            setTimeout(() => {
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                saveBtn.style.backgroundColor = '';
                saveBtn.style.color = '';
                
                // Close settings and show notification
                closeSettings();
                showNotification('Settings saved successfully');
                
                // Update UI
                updateRateLimitDisplay();
                updateWordEstimate();
                updateTokenCount();
                updateAiTokenEstimate();
                
                if (settings.showTokenCounter) {
                    document.getElementById('tokenCounter').classList.add('active');
                } else {
                    document.getElementById('tokenCounter').classList.remove('active');
                }
            }, 600);
        }

        function openSettings() {
            document.getElementById('settingsPanel').classList.add('active');
            document.getElementById('settingsOverlay').classList.add('active');
            loadModelSelection();
            loadQuickPersonas();
            updateTokenCount();
            updateAiTokenEstimate();
        }

        function closeSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            
            // Add closing animation class
            panel.classList.add('closing');
            overlay.classList.add('closing');
            
            setTimeout(() => {
                panel.classList.remove('active');
                panel.classList.remove('closing');
                overlay.classList.remove('active');
                overlay.classList.remove('closing');
            }, 300);
        }

        // --- API PROVIDER SELECTION ---
        function updateProviderUI() {
            const isOpenRouter = settings.selectedProvider === API_PROVIDERS.OPENROUTER;
            const isGroq = settings.selectedProvider === API_PROVIDERS.GROQ;
            const isMistral = settings.selectedProvider === API_PROVIDERS.MISTRAL;
            const isCohere = settings.selectedProvider === API_PROVIDERS.COHERE;
            const isCerebras = settings.selectedProvider === API_PROVIDERS.CEREBRAS;
            
            // Update button styles
            const openRouterBtn = document.getElementById('providerOpenRouter');
            const groqBtn = document.getElementById('providerGroq');
            const mistralBtn = document.getElementById('providerMistral');
            const cohereBtn = document.getElementById('providerCohere');
            const cerebrasBtn = document.getElementById('providerCerebras');
            
            // Reset all buttons
            [openRouterBtn, groqBtn, mistralBtn, cohereBtn, cerebrasBtn].forEach(btn => {
                btn.style.backgroundColor = 'var(--bg-secondary)';
                btn.style.borderColor = 'var(--border-color)';
            });
            
            // Highlight selected button
            if (isOpenRouter) {
                openRouterBtn.style.backgroundColor = 'var(--bg-tertiary)';
                openRouterBtn.style.borderColor = 'var(--text-primary)';
            } else if (isGroq) {
                groqBtn.style.backgroundColor = 'var(--bg-tertiary)';
                groqBtn.style.borderColor = 'var(--text-primary)';
            } else if (isMistral) {
                mistralBtn.style.backgroundColor = 'var(--bg-tertiary)';
                mistralBtn.style.borderColor = 'var(--text-primary)';
            } else if (isCohere) {
                cohereBtn.style.backgroundColor = 'var(--bg-tertiary)';
                cohereBtn.style.borderColor = 'var(--cohere-color)';
            } else if (isCerebras) {
                cerebrasBtn.style.backgroundColor = 'var(--bg-tertiary)';
                cerebrasBtn.style.borderColor = 'var(--cerebras-color)';
            }
            
            // Show/hide API key sections
            const openRouterKeySection = document.getElementById('openRouterApiKeySection');
            const groqKeySection = document.getElementById('groqApiKeySection');
            const mistralKeySection = document.getElementById('mistralApiKeySection');
            const cohereKeySection = document.getElementById('cohereApiKeySection');
            const cerebrasKeySection = document.getElementById('cerebrasApiKeySection');
            
            openRouterKeySection.classList.add('hidden');
            groqKeySection.classList.add('hidden');
            mistralKeySection.classList.add('hidden');
            cohereKeySection.classList.add('hidden');
            cerebrasKeySection.classList.add('hidden');
            
            if (isOpenRouter) {
                openRouterKeySection.classList.remove('hidden');
            } else if (isGroq) {
                groqKeySection.classList.remove('hidden');
            } else if (isMistral) {
                mistralKeySection.classList.remove('hidden');
            } else if (isCohere) {
                cohereKeySection.classList.remove('hidden');
            } else if (isCerebras) {
                cerebrasKeySection.classList.remove('hidden');
            }
            
            // Update API status and display
            const apiStatusText = document.getElementById('apiStatusText');
            let modelName = "Llama 3.3 70B";
            let providerText = "";
            
            if (isOpenRouter) {
                apiStatusText.textContent = 'OpenRouter: Connected';
                providerText = "OpenRouter";
                modelName = settings.selectedModel.split('/').pop() || "GPT-4o Mini";
            } else if (isGroq) {
                apiStatusText.textContent = 'Groq: Connected (FREE)';
                providerText = "Groq";
                modelName = settings.selectedModel.split('-').join(' ') || "Llama 3.3 70B";
            } else if (isMistral) {
                apiStatusText.textContent = 'Mistral: Connected';
                providerText = "Mistral";
                modelName = settings.selectedModel.replace(/-/g, ' ').replace(/latest/g, '') || "Mistral Large";
            } else if (isCohere) {
                apiStatusText.textContent = 'Cohere: Connected';
                providerText = "Cohere";
                modelName = settings.selectedModel.replace(/-/g, ' ') || "Command R";
            } else if (isCerebras) {
                apiStatusText.textContent = 'Cerebras: Connected';
                providerText = "Cerebras";
                modelName = settings.selectedModel.split('-').join(' ') || "Zai GLM 4.7";
            }
            
            document.getElementById('providerDisplay').textContent = modelName;
            document.getElementById('modelBadge').textContent = providerText;
        }

        document.getElementById('providerOpenRouter').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.OPENROUTER;
            settings.selectedModel = "openai/gpt-4o-mini";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to OpenRouter');
        };

        document.getElementById('providerGroq').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.GROQ;
            settings.selectedModel = "llama-3.3-70b-versatile";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to Groq');
        };

        document.getElementById('providerMistral').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.MISTRAL;
            settings.selectedModel = "mistral-large-latest";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to Mistral');
        };

        document.getElementById('providerCohere').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.COHERE;
            settings.selectedModel = "command-r-08-2024";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to Cohere');
        };

        document.getElementById('providerCerebras').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.CEREBRAS;
            settings.selectedModel = "zai-glm-4.7";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to Cerebras');
        };

        // --- AI MODEL SELECTION ---
        function loadModelSelection() {
            const container = document.getElementById('modelSelection');
            container.innerHTML = '';
            
            let models;
            let useCohereStyling = false;
            let useCerebrasStyling = false;
            
            switch(settings.selectedProvider) {
                case API_PROVIDERS.OPENROUTER:
                    models = OPENROUTER_MODELS;
                    break;
                case API_PROVIDERS.GROQ:
                    models = GROQ_MODELS;
                    break;
                case API_PROVIDERS.MISTRAL:
                    models = MISTRAL_MODELS;
                    break;
                case API_PROVIDERS.COHERE:
                    models = COHERE_MODELS;
                    useCohereStyling = true;
                    break;
                case API_PROVIDERS.CEREBRAS:
                    models = CEREBRAS_MODELS;
                    useCerebrasStyling = true;
                    break;
                default:
                    models = GROQ_MODELS;
            }
            
            models.forEach(model => {
                const div = document.createElement('div');
                
                // Use specific styling for different providers
                if (useCohereStyling) {
                    div.className = `cohere-model-card ${model.id === settings.selectedModel ? 'selected' : ''} fade-in`;
                } else if (useCerebrasStyling) {
                    div.className = `cerebras-model-card ${model.id === settings.selectedModel ? 'selected' : ''} fade-in`;
                } else {
                    div.className = `model-card ${model.id === settings.selectedModel ? 'selected' : ''} fade-in`;
                }
                
                div.onclick = () => selectModel(model.id);
                
                const isFree = settings.selectedProvider === API_PROVIDERS.GROQ;
                let costText = '';
                
                if (settings.selectedProvider === API_PROVIDERS.GROQ) {
                    costText = 'FREE';
                } else if (settings.selectedProvider === API_PROVIDERS.COHERE) {
                    costText = 'COHERE';
                } else if (settings.selectedProvider === API_PROVIDERS.MISTRAL) {
                    costText = model.id === 'agent' ? 'AGENT' : 'MISTRAL';
                } else if (settings.selectedProvider === API_PROVIDERS.CEREBRAS) {
                    costText = 'CEREBRAS';
                } else {
                    costText = `$${model.costPerMTok}/MTok`;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-[var(--text-primary)]">${model.name}</div>
                            <div class="text-xs text-[var(--text-secondary)] mt-1">${model.description}</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            ${useCohereStyling ? 
                                `<span class="cohere-badge theme-transition">${model.badge}</span>` : 
                                useCerebrasStyling ?
                                `<span class="cerebras-badge theme-transition">${model.badge}</span>` :
                                `<span class="model-badge theme-transition">${model.badge}</span>`
                            }
                            <span class="text-xs ${isFree ? 'text-green-400' : 
                                settings.selectedProvider === API_PROVIDERS.COHERE ? 'text-[var(--cohere-color)]' : 
                                settings.selectedProvider === API_PROVIDERS.CEREBRAS ? 'text-[var(--cerebras-color)]' : 
                                'text-yellow-400'}">${costText}</span>
                        </div>
                    </div>
                    <div class="text-xs text-[var(--text-tertiary)] mt-2 flex justify-between">
                        <span>${model.maxTokens.toLocaleString()} tokens</span>
                        ${model.recommended ? '<span class="text-green-400">âœ“ Recommended</span>' : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function selectModel(modelId) {
            settings.selectedModel = modelId;
            updateModelBadge();
            
            // Get current model to update max tokens
            let models;
            switch(settings.selectedProvider) {
                case API_PROVIDERS.OPENROUTER:
                    models = OPENROUTER_MODELS;
                    break;
                case API_PROVIDERS.GROQ:
                    models = GROQ_MODELS;
                    break;
                case API_PROVIDERS.MISTRAL:
                    models = MISTRAL_MODELS;
                    break;
                case API_PROVIDERS.COHERE:
                    models = COHERE_MODELS;
                    break;
                case API_PROVIDERS.CEREBRAS:
                    models = CEREBRAS_MODELS;
                    break;
                default:
                    models = GROQ_MODELS;
            }
            
            const selectedModel = models.find(m => m.id === modelId);
            
            if (selectedModel) {
                // Update max tokens slider if current value exceeds model limit
                if (settings.maxTokens > selectedModel.maxTokens) {
                    settings.maxTokens = selectedModel.maxTokens;
                    document.getElementById('maxTokens').value = selectedModel.maxTokens;
                    document.getElementById('maxTokens').max = selectedModel.maxTokens;
                    document.getElementById('tokenValue').textContent = `${selectedModel.maxTokens} tokens`;
                    updateWordEstimate();
                    updateTokenCount();
                } else {
                    document.getElementById('maxTokens').max = selectedModel.maxTokens;
                }
                
                // Update provider display with model name
                let displayName = selectedModel.name;
                document.getElementById('providerDisplay').textContent = displayName;
                
                showNotification(`Switched to ${selectedModel.name}`);
            }
            
            loadModelSelection();
        }

        function updateModelBadge() {
            let providerText = "";
            switch(settings.selectedProvider) {
                case API_PROVIDERS.OPENROUTER:
                    providerText = "OpenRouter";
                    break;
                case API_PROVIDERS.GROQ:
                    providerText = "Groq";
                    break;
                case API_PROVIDERS.MISTral:
                    providerText = "Mistral";
                    break;
                case API_PROVIDERS.COHERE:
                    providerText = "Cohere";
                    break;
                case API_PROVIDERS.CEREBRAS:
                    providerText = "Cerebras";
                    break;
            }
            document.getElementById('modelBadge').textContent = providerText;
        }

        // --- PERSONA MANAGEMENT ---
        function loadQuickPersonas() {
            const container = document.getElementById('quickPersonas');
            container.innerHTML = '';
            
            QUICK_PERSONAS.forEach(persona => {
                const button = document.createElement('button');
                button.className = `quick-persona-btn theme-transition ${persona.id === settings.selectedPersona ? 'active' : ''}`;
                button.textContent = persona.name;
                button.title = persona.prompt.substring(0, 100) + '...';
                button.onclick = () => applyQuickPersona(persona.id);
                
                container.appendChild(button);
            });
        }

        function applyQuickPersona(personaId) {
            const persona = QUICK_PERSONAS.find(p => p.id === personaId);
            if (!persona) return;
            
            settings.systemPrompt = persona.prompt;
            settings.selectedPersona = personaId;
            
            // Update UI
            document.getElementById('systemPrompt').value = persona.prompt;
            
            // Update quick persona buttons
            document.querySelectorAll('.quick-persona-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === persona.name) {
                    btn.classList.add('active');
                }
            });
            
            // Update token count
            updateTokenCount();
            updateAiTokenEstimate();
            
            showNotification(`${persona.name} persona applied`);
        }

        // --- RATE LIMITING ---
        function canMakeRequest() {
            if (!settings.enableRateLimit) return true;
            
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            
            requestTimestamps = requestTimestamps.filter(time => time > oneMinuteAgo);
            
            if (requestTimestamps.length >= settings.rateLimit) {
                return false;
            }
            
            requestTimestamps.push(now);
            updateRateLimitDisplay();
            return true;
        }

        function updateRateLimitDisplay() {
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            requestTimestamps = requestTimestamps.filter(time => time > oneMinuteAgo);
            
            document.getElementById('requestCount').textContent = requestTimestamps.length;
            document.getElementById('rateLimitMax').textContent = settings.rateLimit;
            
            const rateLimitInfo = document.getElementById('rateLimitInfo');
            if (requestTimestamps.length >= settings.rateLimit * 0.8) {
                rateLimitInfo.style.color = 'var(--error-color)';
            } else {
                rateLimitInfo.style.color = 'var(--text-tertiary)';
            }
        }

        // --- TOKEN COUNTING (FASTER & HARSHER) ---
        function estimateTokens(text) {
            if (!text || text.trim() === '') return 0;
            
            // Faster token estimation - more aggressive
            const cleaned = text.trim().replace(/\s+/g, ' ');
            const words = cleaned.split(' ').length;
            
            // Harsher token count - counts more tokens per word
            return Math.ceil(words * 1.5); // Increased from 1.3 to 1.5
        }

        function updateTokenCount() {
            const prompt = document.getElementById('systemPrompt').value;
            const tokens = estimateTokens(prompt);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            document.getElementById('promptTokens').textContent = tokens;
            
            if (settings.showTokenCounter) {
                updateTokenCounterDisplay();
            }
        }

        function updateInputTokenCount() {
            const input = document.getElementById('userInput').value;
            const tokens = estimateTokens(input);
            
            document.getElementById('inputTokenCount').textContent = tokens;
            
            if (tokens > 0) {
                document.getElementById('inputTokenCounter').classList.remove('hidden');
                
                if (tokens > 1000) {
                    document.getElementById('inputTokenCounter').style.color = 'var(--error-color)';
                } else {
                    document.getElementById('inputTokenCounter').style.color = 'var(--text-tertiary)';
                }
            } else {
                document.getElementById('inputTokenCounter').classList.add('hidden');
            }
        }

        function updateAiTokenEstimate() {
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const promptTokens = estimateTokens(document.getElementById('systemPrompt').value);
            const currentTokens = totalConversationTokens + promptTokens;
            const availableForAI = Math.max(0, maxTokens - currentTokens);
            
            const aiEstimateElement = document.getElementById('aiTokenEstimate');
            const aiEstimateDisplay = document.getElementById('aiTokenEstimateDisplay');
            
            let estimateClass = '';
            if (availableForAI < maxTokens * 0.3) {
                estimateClass = 'critical';
            } else if (availableForAI < maxTokens * 0.5) {
                estimateClass = 'high';
            }
            
            aiEstimateElement.textContent = `AI: ~${availableForAI} tokens`;
            aiEstimateElement.className = `ai-token-estimate ${estimateClass}`;
            
            if (aiEstimateDisplay) {
                aiEstimateDisplay.textContent = `AI: ~${availableForAI} tokens`;
            }
        }

        function updateTokenCounterDisplay() {
            const tokenCounter = document.getElementById('tokenCounter');
            const progressBar = document.getElementById('tokenProgressBar');
            const tokenCount = document.getElementById('tokenCount');
            const tokenPercentage = document.getElementById('tokenPercentage');
            const tokenEstimate = document.getElementById('tokenEstimate');
            
            const currentTokens = totalConversationTokens + estimateTokens(document.getElementById('systemPrompt').value);
            const dailyPercentage = Math.min((dailyTokenUsage / DAILY_TOKEN_LIMIT) * 100, 100);
            const conversationPercentage = Math.min((currentTokens / settings.maxTokens) * 100, 100);
            
            // Update daily token counter
            const totalTokens = Math.min(dailyTokenUsage, DAILY_TOKEN_LIMIT);
            tokenCount.textContent = `${totalTokens}/${DAILY_TOKEN_LIMIT}`;
            tokenPercentage.textContent = `${Math.round(dailyPercentage)}%`;
            
            // Update progress bar with faster animation
            progressBar.style.width = `${dailyPercentage}%`;
            
            // Apply harsh visual feedback based on usage
            if (dailyPercentage >= 100) {
                // CRITICAL - Over limit
                tokenCounter.classList.add('critical');
                progressBar.classList.add('critical');
                tokenCount.style.color = 'var(--error-color)';
                tokenPercentage.style.color = 'var(--error-color)';
                tokenEstimate.style.color = 'var(--error-color)';
                tokenEstimate.textContent = 'LIMIT REACHED!';
                
                // Show notification if not already shown
                if (!document.querySelector('.login-overlay.active')) {
                    showTokenLimitNotification();
                }
            } else if (dailyPercentage >= 80) {
                // WARNING - Almost limit
                tokenCounter.classList.remove('critical');
                progressBar.classList.remove('critical');
                progressBar.classList.add('warning');
                tokenCount.style.color = 'var(--warning-color)';
                tokenPercentage.style.color = 'var(--warning-color)';
                tokenEstimate.style.color = 'var(--warning-color)';
                tokenEstimate.textContent = `~${Math.floor(dailyTokenUsage / 1.5)} words - WARNING!`;
            } else {
                // NORMAL
                tokenCounter.classList.remove('critical');
                progressBar.classList.remove('critical');
                progressBar.classList.remove('warning');
                tokenCount.style.color = 'var(--text-primary)';
                tokenPercentage.style.color = 'var(--text-secondary)';
                tokenEstimate.style.color = 'var(--text-tertiary)';
                tokenEstimate.textContent = `~${Math.floor(dailyTokenUsage / 1.5)} words`;
            }
            
            // Update AI token estimate
            updateAiTokenEstimate();
        }

        function toggleTokenCounter() {
            settings.showTokenCounter = !settings.showTokenCounter;
            document.getElementById('showTokenCounter').checked = settings.showTokenCounter;
            
            if (settings.showTokenCounter) {
                document.getElementById('tokenCounter').classList.add('active');
                updateTokenCount();
                updateAiTokenEstimate();
                updateTokenCounterDisplay();
            } else {
                document.getElementById('tokenCounter').classList.remove('active');
            }
            
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const currentSettings = JSON.parse(saved);
                currentSettings.showTokenCounter = settings.showTokenCounter;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
            }
        }

        function updateWordEstimate() {
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const words = Math.floor(maxTokens / 1.5); // Adjusted for harsher token count
            document.getElementById('wordEstimate').textContent = words.toLocaleString();
            
            if (settings.showTokenCounter) {
                const promptTokens = estimateTokens(document.getElementById('systemPrompt').value);
                updateTokenCounterDisplay();
                updateAiTokenEstimate();
            }
        }

        // Track AI response tokens
        function trackAiResponse(text) {
            const tokens = estimateTokens(text);
            lastAiResponseTokens = tokens;
            totalConversationTokens += tokens;
            updateDailyTokenUsage(tokens);
            
            if (settings.showTokenCounter) {
                updateTokenCounterDisplay();
                updateAiTokenEstimate();
            }
        }

        // Track user message tokens
        function trackUserMessage(text) {
            const tokens = estimateTokens(text);
            totalConversationTokens += tokens;
            updateDailyTokenUsage(tokens);
            
            if (settings.showTokenCounter) {
                updateTokenCounterDisplay();
                updateAiTokenEstimate();
            }
        }

        // --- CHAT HISTORY ---
        function saveMessage(role, content) {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            history.push({
                role,
                content,
                timestamp: new Date().toISOString(),
                model: settings.selectedModel,
                provider: settings.selectedProvider,
                persona: settings.selectedPersona
            });
            if (history.length > 100) history.splice(0, history.length - 100);
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            // Reset conversation token counter when loading history
            totalConversationTokens = 0;
            
            history.forEach(msg => {
                if (msg.role === 'system') return;
                appendMessage(msg.content, msg.role);
                
                // Track tokens from loaded messages
                if (msg.role === 'user') {
                    trackUserMessage(msg.content);
                } else if (msg.role === 'ai') {
                    trackAiResponse(msg.content);
                }
            });
            
            // Check if we should show welcome message
            if (history.length === 0) {
                checkWelcomeMessage();
            } else {
                hasUserSentMessage = true;
                fadeOutWelcomeMessage();
            }
        }

        function clearHistory() {
            if (confirm('Clear all chat history?')) {
                // Backup current chat before clearing
                backupLastChat();
                
                localStorage.removeItem(CHAT_HISTORY_KEY);
                document.getElementById('chat-window').innerHTML = '';
                totalConversationTokens = 0;
                lastAiResponseTokens = 0;
                hasUserSentMessage = false;
                
                // Show welcome message again
                checkWelcomeMessage();
                
                if (settings.showTokenCounter) {
                    updateTokenCount();
                    updateAiTokenEstimate();
                    updateTokenCounterDisplay();
                }
                
                showNotification('Chat history cleared');
            }
        }

        function exportHistory() {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            const dataStr = JSON.stringify(history, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `notam-chat-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            showNotification('Chat exported');
        }

        function importHistory() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const history = JSON.parse(e.target.result);
                    localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
                    document.getElementById('chat-window').innerHTML = '';
                    
                    // Reset token counters when importing
                    totalConversationTokens = 0;
                    lastAiResponseTokens = 0;
                    hasUserSentMessage = history.length > 0;
                    
                    loadChatHistory();
                    showNotification('Chat imported');
                } catch (error) {
                    showNotification('Error importing chat', true);
                }
            };
            reader.readAsText(file);
        });

        // --- SEARCH ---
        document.getElementById('searchChat').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const messages = document.querySelectorAll('.message-content');
            
            messages.forEach(msg => {
                const content = msg.textContent.toLowerCase();
                const messageDiv = msg.closest('.message-container');
                
                if (term.length >= 2) {
                    if (content.includes(term)) {
                        messageDiv.style.display = 'block';
                        const html = msg.innerHTML.replace(
                            new RegExp(term, 'gi'),
                            match => `<mark style="background: rgba(251, 191, 36, 0.3); padding: 0 2px;">${match}</mark>`
                        );
                        msg.innerHTML = html;
                    } else {
                        messageDiv.style.display = 'none';
                    }
                } else {
                    messageDiv.style.display = 'block';
                    msg.innerHTML = msg.innerHTML.replace(/<mark[^>]*>([^<]+)<\/mark>/gi, '$1');
                }
            });
        });

        // --- CORE LOGIC ---
        async function initSystem() {
            // Check token reset first
            checkTokenReset();
            
            // Show welcome message typing animation
            setTimeout(() => {
                typeWelcomeMessage();
            }, 500);
            
            // Load settings
            loadSettings();
            
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
            } catch(e) { /* ignore */ }

            loadChatHistory();

            if (!localStorage.getItem(CHAT_HISTORY_KEY)) {
                appendMessage("Hello! I'm NOTAM AI. How can I help you today?", 'ai');
            }
            
            updateTokenCount();
            updateProviderUI();
            loadQuickPersonas();
            updateThemeSwitcherIcons();
            updateAiTokenEstimate();
            updateTokenCounterDisplay();
        }

        initSystem();

        // --- CHAT LOGIC ---
        async function sendMessage() {
            // Check if daily token limit is reached
            if (dailyTokenUsage >= DAILY_TOKEN_LIMIT) {
                showTokenLimitNotification();
                return;
            }
            
            if (!canMakeRequest()) {
                showRateLimitWarning();
                return;
            }

            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const text = input.value.trim();

            if (!text) return;

            // User Message
            appendMessage(text, 'user');
            saveMessage('user', text);
            trackUserMessage(text);
            
            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;
            
            document.getElementById('inputTokenCounter').classList.add('hidden');

            // Fade out welcome message on first user message
            if (!hasUserSentMessage) {
                hasUserSentMessage = true;
                fadeOutWelcomeMessage();
            }

            // Create loading indicator for AI response
            const aiMsgDiv = createMessageDiv('ai');
            const contentDiv = aiMsgDiv.querySelector('.message-content');
            
            // Add loading animation
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'ai-loading';
            loadingDiv.innerHTML = '<div class="ai-loading-dot"></div><div class="ai-loading-dot"></div><div class="ai-loading-dot"></div>';
            contentDiv.appendChild(loadingDiv);

            let fullContent = "";

            try {
                let apiUrl, headers, body;
                let apiKeyToUse;
                
                if (settings.selectedProvider === API_PROVIDERS.OPENROUTER) {
                    apiUrl = "https://openrouter.ai/api/v1/chat/completions";
                    apiKeyToUse = settings.openRouterApiKey || OPENROUTER_API_KEY;
                    headers = {
                        "Authorization": `Bearer ${apiKeyToUse}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": OPENROUTER_REFERRER,
                        "X-Title": "NOTAM AI"
                    };
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        temperature: settings.temperature,
                        max_tokens: settings.maxTokens,
                        stream: true
                    };
                } else if (settings.selectedProvider === API_PROVIDERS.GROQ) {
                    apiUrl = "https://api.groq.com/openai/v1/chat/completions";
                    apiKeyToUse = settings.groqApiKey || GROQ_API_KEY;
                    headers = {
                        "Authorization": `Bearer ${apiKeyToUse}`,
                        "Content-Type": "application/json"
                    };
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        temperature: settings.temperature,
                        max_tokens: settings.maxTokens,
                        stream: true
                    };
                } else if (settings.selectedProvider === API_PROVIDERS.MISTRAL) {
                    const isAgent = settings.selectedModel === 'agent';
                    apiUrl = isAgent 
                        ? 'https://api.mistral.ai/v1/conversations' 
                        : 'https://api.mistral.ai/v1/chat/completions';
                    
                    apiKeyToUse = settings.mistralApiKey || DEFAULT_MISTRAL_KEY;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKeyToUse}`
                    };
                    
                    if (isAgent) {
                        body = {
                            agent_id: settings.mistralAgentId || DEFAULT_MISTRAL_AGENT,
                            inputs: [{ role: "user", content: text }]
                        };
                    } else {
                        body = {
                            model: settings.selectedModel,
                            messages: [
                                { 
                                    role: "system", 
                                    content: settings.systemPrompt
                                },
                                { role: "user", content: text }
                            ],
                            temperature: settings.temperature,
                            max_tokens: settings.maxTokens
                        };
                    }
                    
                    if (isAgent) {
                        body.stream = false;
                    } else {
                        body.stream = true;
                    }
                } else if (settings.selectedProvider === API_PROVIDERS.COHERE) {
                    apiUrl = "https://api.cohere.com/v2/chat";
                    apiKeyToUse = settings.cohereApiKey || DEFAULT_COHERE_KEY;
                    headers = {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKeyToUse}`
                    };
                    
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        temperature: settings.temperature
                    };
                } else if (settings.selectedProvider === API_PROVIDERS.CEREBRAS) {
                    apiUrl = CEREBRAS_API_URL;
                    apiKeyToUse = settings.cerebrasApiKey || DEFAULT_CEREBRAS_KEY;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKeyToUse}`
                    };
                    
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        stream: true,
                        max_tokens: 65000,
                        temperature: settings.temperature,
                        top_p: 0.95
                    };
                }

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText}`);
                }

                // Remove loading indicator
                loadingDiv.remove();

                if (settings.selectedProvider === API_PROVIDERS.MISTRAL && settings.selectedModel === 'agent') {
                    const data = await response.json();
                    
                    if (data.outputs && Array.isArray(data.outputs)) {
                        const assistantOutputs = data.outputs.filter(o => o.role === 'assistant');
                        fullContent = assistantOutputs.length > 0 ? assistantOutputs[assistantOutputs.length - 1].content : "No output received.";
                    } else if (data.entries) {
                        const assistantEntries = data.entries.filter(e => e.role === 'assistant');
                        fullContent = assistantEntries.length > 0 ? assistantEntries[assistantEntries.length - 1].content : "No entries received.";
                    } else {
                        throw new Error("Unexpected Agent Response Format");
                    }
                    
                    contentDiv.innerHTML = marked.parse(fullContent);
                    processCodeBlocks(contentDiv);
                    trackAiResponse(fullContent);
                } else if (settings.selectedProvider === API_PROVIDERS.COHERE) {
                    const data = await response.json();
                    const aiResponse = data.message.content[0].text;
                    fullContent = aiResponse;
                    
                    contentDiv.innerHTML = marked.parse(fullContent);
                    processCodeBlocks(contentDiv);
                    trackAiResponse(fullContent);
                } else {
                    // Handle streaming responses for other providers
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split("\n");

                        for (const line of lines) {
                            if (line.startsWith("data: ") && line !== "data: [DONE]") {
                                try {
                                    const jsonData = JSON.parse(line.substring(6));
                                    const content = jsonData.choices[0].delta.content || "";
                                    fullContent += content;
                                    contentDiv.innerHTML = marked.parse(fullContent);
                                    
                                    processCodeBlocks(contentDiv);
                                    
                                    document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                                } catch (e) {
                                    // Skip parsing errors
                                }
                            }
                        }
                    }
                    
                    trackAiResponse(fullContent);
                }

                saveMessage('ai', fullContent);

            } catch (error) {
                loadingDiv.remove();
                console.error('API Error:', error);
                contentDiv.innerText = `Error: ${error.message}`;
                saveMessage('ai', `Error: ${error.message}`);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
                updateRateLimitDisplay();
                
                setTimeout(() => {
                    scrollToBottom();
                }, 100);
            }
        }

        function processCodeBlocks(contentDiv) {
            contentDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
            
            contentDiv.querySelectorAll('pre').forEach(pre => {
                if (!pre.parentElement.classList.contains('.code-block')) {
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `
                        <span>Code</span>
                        <button class="code-copy-btn" onclick="copyCode(this)">Copy</button>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'code-content';
                    contentDiv.appendChild(pre.cloneNode(true));
                    
                    codeBlock.appendChild(header);
                    codeBlock.appendChild(contentDiv);
                    
                    pre.replaceWith(codeBlock);
                }
            });
        }

        // --- UI HELPERS ---
        function createMessageDiv(sender) {
            const chatWindow = document.getElementById('chat-window');
            const wrapper = document.createElement('div');
            wrapper.className = `message-container ${sender === 'user' ? 'flex justify-end' : 'flex justify-start'} fade-in`;
            
            const div = document.createElement('div');
            div.className = `${sender === 'user' ? 'user-message' : 'ai-message'} theme-transition`;
            
            const content = document.createElement('div');
            content.className = 'message-content prose prose-invert max-w-none';
            content.style.color = sender === 'user' ? 'white' : 'var(--text-primary)';
            div.appendChild(content);

            wrapper.appendChild(div);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            // Add copy button to AI messages
            if (sender === 'ai') {
                addCopyButtonToAIMessage(div);
            }
            
            return div;
        }

        function appendMessage(text, sender) {
            const div = createMessageDiv(sender);
            const contentDiv = div.querySelector('.message-content');
            contentDiv.innerHTML = marked.parse(text);
            
            processCodeBlocks(contentDiv);
        }

        function showRateLimitWarning() {
            const warning = document.createElement('div');
            warning.className = 'p-3 bg-[var(--bg-secondary)] border border-[var(--border-color)] rounded-lg text-sm text-[var(--error-color)] my-2 fade-in theme-transition';
            warning.textContent = `Rate limit exceeded. Maximum ${settings.rateLimit} requests per minute.`;
            
            const chatWindow = document.getElementById('chat-window');
            chatWindow.appendChild(warning);
            
            setTimeout(() => warning.remove(), 5000);
        }

        function copyCode(button) {
            const codeBlock = button.closest('.code-block');
            const codeElement = codeBlock.querySelector('code');
            const codeText = codeElement.textContent;
            
            navigator.clipboard.writeText(codeText);
            button.textContent = 'Copied!';
            button.style.color = 'var(--success-color)';
            
            setTimeout(() => {
                button.textContent = 'Copy';
                button.style.color = '';
            }, 2000);
        }

        // --- SETTINGS UI UPDATES ---
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
        });

        document.getElementById('maxTokens').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('tokenValue').textContent = `${value} tokens`;
            updateWordEstimate();
            updateTokenCount();
            updateAiTokenEstimate();
        });

        document.getElementById('userInput').addEventListener('input', updateInputTokenCount);

        // Initialize
        setInterval(updateRateLimitDisplay, 5000);
        // Check token reset every hour
        setInterval(checkTokenReset, 60 * 60 * 1000);
    </script>
</body>
</html>
