<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anonymous Chat</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" id="manifest-link">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-attachment: fixed;
            height: 100vh;
            width: 100vw;
            margin: 0;
            overflow: hidden; 
            display: flex;
            justify-content: center;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(96, 165, 250, 0.5);
            outline: none;
        }

        #chat-container {
            overflow-y: auto;
            overflow-x: hidden;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2); 
            border-radius: 10px;
        }

        .msg-enter {
            animation: fadeIn 0.25s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: 0;
            opacity: 0.4;
            pointer-events: none;
        }

        #settings-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease;
        }
        
        #settings-panel.open {
            max-height: 200px;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="relative">

    <div class="orb w-[500px] h-[500px] bg-blue-600 top-[-100px] left-[-100px] fixed"></div>
    <div class="orb w-[400px] h-[400px] bg-purple-600 bottom-[-50px] right-[-50px] fixed"></div>

    <div class="relative z-10 flex flex-col h-full w-full max-w-5xl glass-panel shadow-2xl overflow-hidden">
        
        <header class="flex flex-col border-b border-white/10 bg-black/20 backdrop-blur-md shrink-0">
            <!-- Top Nav -->
            <div class="p-4 flex items-center justify-between">
                <div class="flex flex-col">
                    <h1 class="text-white font-bold text-lg leading-tight tracking-tight">Anonymous Chat</h1>
                    <div class="flex items-center gap-2">
                        <span id="ip-display" class="text-[10px] font-mono text-blue-400">...</span>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="installBtn" class="hidden flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold transition-all active:scale-95">
                        <i class="ph ph-download-simple"></i>
                        <span class="hidden xs:inline">Install</span>
                    </button>

                    <button onclick="toggleSettings()" class="w-9 h-9 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 transition-all text-white border border-white/10 shrink-0">
                        <i class="ph ph-gear text-lg"></i>
                    </button>

                    <button onclick="window.location.reload()" 
                        class="w-9 h-9 flex items-center justify-center rounded-xl bg-white/5 hover:bg-white/10 transition-all text-white border border-white/10 shrink-0" 
                        title="Refresh Page">
                        <i class="ph ph-arrows-clockwise text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settings-panel" class="bg-black/30">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] uppercase font-bold text-white/40 px-1">Active Room</label>
                        <div class="flex items-center glass-input rounded-xl px-3 py-2 gap-2 border border-white/5">
                            <i class="ph ph-hash text-blue-400 text-sm"></i>
                            <input id="roomInput" type="text" value="general" 
                                class="bg-transparent text-sm text-white font-medium focus:outline-none w-full" 
                                placeholder="room name">
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] uppercase font-bold text-white/40 px-1">Chat Options</label>
                        <button onclick="clearChatCache()" class="glass-input rounded-xl px-3 py-2 text-xs text-left text-white/70 hover:text-white flex items-center gap-2">
                            <i class="ph ph-trash"></i> Clear local history
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main id="chat-container" class="flex-1 p-4 sm:p-6 space-y-6">
            <!-- Messages inject here -->
            <div id="loading-indicator" class="flex flex-col justify-center items-center h-full gap-4">
                <i class="ph ph-circle-notch animate-spin text-blue-400 text-4xl"></i>
            </div>
        </main>

        <footer class="p-4 bg-black/40 border-t border-white/10 backdrop-blur-md shrink-0">
            <div class="flex gap-2 items-center">
                <div class="flex-1 relative">
                    <input id="textInput" type="text" placeholder="Type a message..." 
                        class="glass-input w-full px-4 py-3 rounded-xl text-sm placeholder-white/30"
                        autocomplete="off">
                </div>

                <div class="w-24 sm:w-32 relative">
                    <input id="userInput" type="text" placeholder="Nick" 
                        class="glass-input w-full px-3 py-3 rounded-xl text-sm text-center placeholder-white/30 truncate">
                </div>

                <button onclick="send()" id="sendBtn" 
                    class="bg-blue-600 hover:bg-blue-500 text-white rounded-xl w-12 h-11 flex items-center justify-center transition-all active:scale-95 disabled:opacity-50 shrink-0">
                    <i class="ph ph-paper-plane-right text-lg"></i>
                </button>
            </div>
        </footer>
    </div>

    <script>
        const WORKER_URL = "https://swiftchat.sawyerbobk563.workers.dev/"; 
        let currentRoom = "general";
        let lastMessageHash = "";
        let isSending = false;
        let deferredPrompt;

        // Settings Toggle
        function toggleSettings() {
            document.getElementById('settings-panel').classList.toggle('open');
        }

        function clearChatCache() {
            lastMessageHash = "";
            load(true);
            toggleSettings();
        }

        const manifest = {
            name: "Anonymous Chat",
            short_name: "AnonChat",
            start_url: ".",
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#0f172a",
            icons: [{
                src: "https://cdn-icons-png.flaticon.com/512/5968/5968756.png",
                sizes: "512x512",
                type: "image/png"
            }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-link').setAttribute('href', URL.createObjectURL(blob));

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('installBtn');
            btn.classList.remove('hidden');
            btn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') btn.classList.add('hidden');
                    deferredPrompt = null;
                }
            });
        });

        async function fetchIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                document.getElementById('ip-display').innerText = data.ip;
            } catch (e) {
                document.getElementById('ip-display').innerText = "127.0.0.1";
            }
        }

        const storedUser = localStorage.getItem('swiftchat_user');
        if (storedUser) document.getElementById('userInput').value = storedUser;

        document.getElementById('roomInput').addEventListener('change', (e) => {
            currentRoom = e.target.value.trim().toLowerCase() || "general";
            load(true);
        });

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') send();
        });

        function escapeHtml(text) {
            if (!text) return "";
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            // If within last 24 hours, show time only
            if (diffInHours < 24) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            // Otherwise show date and time
            return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' ' + 
                   date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        async function load(forceScroll = false) {
            try {
                const res = await fetch(`${WORKER_URL}?room=${currentRoom}`);
                const data = await res.json();
                
                const newHash = JSON.stringify(data);
                if (newHash === lastMessageHash && !forceScroll) return;
                lastMessageHash = newHash;

                const chat = document.getElementById('chat-container');
                const currentUser = document.getElementById('userInput').value || "Anon";
                
                // Track if we should scroll (user is at bottom or it's a forced load)
                const isAtBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 100;

                if (data.length === 0) {
                    chat.innerHTML = `<div class="flex-1 flex flex-col items-center justify-center text-white/20"><i class="ph ph-chat-teardrop-dots text-6xl mb-4"></i><p>No messages in #${currentRoom}</p></div>`;
                } else {
                    chat.innerHTML = data.map(m => {
                        const isMe = m.user === currentUser;
                        const timestamp = formatTimestamp(m.timestamp);
                        
                        return `
                        <div class="msg-enter flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[85%]">
                                <div class="flex items-center gap-2 mb-1 px-1">
                                    <span class="text-[10px] font-bold tracking-wide ${isMe ? 'text-blue-400' : 'text-white/40'}">${escapeHtml(m.user)}</span>
                                    ${timestamp ? `<span class="text-[9px] text-white/30 font-mono">${timestamp}</span>` : ''}
                                </div>
                                <div class="${isMe ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none' : 'bg-white/5 border border-white/10 rounded-2xl rounded-tl-none'} px-4 py-2 text-sm break-words shadow-lg">
                                    ${escapeHtml(m.text)}
                                </div>
                            </div>
                        </div>`;
                    }).join('') + '<div class="h-2 shrink-0"></div>'; // Spacer at bottom
                }

                if (forceScroll || isAtBottom) {
                    chat.scrollTo({ top: chat.scrollHeight, behavior: forceScroll ? 'auto' : 'smooth' });
                }
            } catch (err) { console.error(err); }
        }

        async function send() {
            const textInput = document.getElementById('textInput');
            const userInput = document.getElementById('userInput');
            const text = textInput.value.trim();
            const user = userInput.value.trim() || "Anon";

            if (!text || isSending) return;
            isSending = true;
            document.getElementById('sendBtn').disabled = true;
            localStorage.setItem('swiftchat_user', user);

            try {
                await fetch(`${WORKER_URL}?room=${currentRoom}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user, 
                        text,
                        timestamp: new Date().toISOString() // Add timestamp when sending
                    })
                });
                textInput.value = '';
                load(true);
            } finally {
                isSending = false;
                document.getElementById('sendBtn').disabled = false;
                textInput.focus();
            }
        }

        fetchIP();
        load(true);
        setInterval(() => load(false), 2000); 
    </script>
</body>
</html>
