<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>NOTAM AI</title>
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" id="manifest-placeholder">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #000000 100%);
            height: 100vh;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .glass-panel {
            background: rgba(20, 20, 25, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Smooth Scrollbar */
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

        /* Message Styling */
        .ai-message {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 4px;
            color: #e2e8f0;
            position: relative;
        }

        .user-message {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); /* NOTAM Red theme */
            border-bottom-right-radius: 4px;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* Animations */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-anim {
            animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Markdown Styling */
        .ai-message p { margin-bottom: 0.8rem; }
        .ai-message ul, .ai-message ol { margin-left: 1.5rem; margin-bottom: 1rem; list-style-type: disc; }
        .ai-message strong { color: #f87171; font-weight: 700; } /* Red accent */
        .ai-message code:not(pre code) { background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #fca5a5; }
        
        /* Code block styling */
        .code-block {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin: 1rem 0;
            overflow: hidden;
        }
        .code-header {
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: monospace;
            font-size: 12px;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-copy-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .code-copy-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        .code-content {
            padding: 12px;
            overflow-x: auto;
        }
        .code-content pre {
            margin: 0;
        }

        /* Background Glow */
        .glow {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(220, 38, 38, 0.15) 0%, transparent 70%);
            filter: blur(80px);
            z-index: -1;
            animation: pulse 6s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        /* Copy Button */
        .copy-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .ai-message:hover .copy-btn {
            opacity: 1;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px;
            overflow-y: auto;
        }
        .settings-panel.active {
            right: 0;
        }
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 999;
            display: none;
        }
        .settings-overlay.active {
            display: block;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background: rgba(239, 68, 68, 0.7);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Rate Limit Warning */
        .rate-limit-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px;
            font-size: 12px;
            color: #fca5a5;
            animation: slideUpFade 0.3s;
        }

        /* Search Highlight */
        .search-highlight {
            background: rgba(251, 191, 36, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }

        /* Model Select */
        .model-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .model-select:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(239, 68, 68, 0.3);
        }
        .model-select.selected {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .model-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* Persona Select */
        .persona-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .persona-select:hover {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(59, 130, 246, 0.3);
        }
        .persona-select.selected {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
        }
        .persona-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 6px;
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        /* Token Counter */
        .token-counter {
            position: fixed;
            bottom: 100px;
            right: 30px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            font-family: monospace;
            font-size: 12px;
            color: #94a3b8;
            z-index: 100;
            display: none;
        }
        .token-counter.active {
            display: block;
        }
        .token-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .token-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            border-radius: 2px;
            transition: width 0.3s;
        }
        .token-warning {
            color: #ef4444;
        }
        
        /* API Status */
        .api-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }
        .api-status.offline {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        /* Quick Persona Buttons */
        .quick-persona-btn {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .quick-persona-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }
        .quick-persona-btn.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }
    </style>
</head>
<body class="flex items-center justify-center p-2 sm:p-4">
    
    <!-- Dynamic Background Glows -->
    <div class="glow" style="top: -10%; left: -10%;"></div>
    <div class="glow" style="bottom: -10%; right: -10%; animation-delay: 3s;"></div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="settings-overlay" onclick="closeSettings()"></div>

    <!-- Token Counter -->
    <div id="tokenCounter" class="token-counter">
        <div class="flex justify-between items-center">
            <span>Tokens:</span>
            <span id="tokenCount">0/1024</span>
        </div>
        <div class="token-progress">
            <div id="tokenProgressBar" class="token-progress-bar" style="width: 0%"></div>
        </div>
        <div class="text-xs mt-1 text-gray-500" id="tokenEstimate">~0 words</div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-white text-xl font-bold">SETTINGS</h2>
            <button onclick="closeSettings()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="space-y-6">
            <!-- API Provider Selection -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-3">API Provider</label>
                <div class="flex gap-2 mb-4">
                    <button id="providerOpenRouter" class="px-4 py-2 rounded-lg bg-red-500/20 text-red-400 border border-red-500/30 font-bold text-sm">OpenRouter</button>
                    <button id="providerGroq" class="px-4 py-2 rounded-lg bg-white/10 text-white border border-white/10 font-bold text-sm">Groq</button>
                </div>
                <div id="apiStatus" class="api-status">
                    <div class="h-1.5 w-1.5 rounded-full bg-green-500"></div>
                    <span>OpenRouter: Connected</span>
                </div>
            </div>

            <!-- Quick Persona Buttons -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-2">Quick Personas</label>
                <div class="flex flex-wrap gap-2 mb-3" id="quickPersonas">
                    <!-- Persona buttons will be injected here -->
                </div>
            </div>

            <!-- AI Model Selection -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-3">AI Model</label>
                <div class="space-y-2" id="modelSelection">
                    <!-- Models will be populated here -->
                </div>
            </div>

            <!-- System Prompt -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-2">System Prompt</label>
                <textarea id="systemPrompt" rows="6" class="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white text-sm focus:outline-none focus:border-red-500/50 resize-none" oninput="updateTokenCount()"></textarea>
                <div class="flex justify-between mt-1">
                    <p class="text-gray-400 text-xs">Customize how the AI behaves</p>
                    <p class="text-gray-400 text-xs">
                        Tokens: <span id="promptTokens">0</span>
                    </p>
                </div>
            </div>

            <!-- Preset Personas -->
            <div id="presetPersonasSection">
                <label class="block text-gray-300 text-sm font-bold mb-3">Preset Personas</label>
                <div class="space-y-2" id="presetPersonas">
                    <!-- Personas will be populated here -->
                </div>
            </div>

            <!-- Temperature -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-2">
                    Temperature: <span id="tempValue">0.7</span>
                </label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" 
                       class="w-full h-2 bg-black/30 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-red-500">
                <p class="text-gray-400 text-xs mt-1">Higher = more creative, Lower = more focused</p>
            </div>

            <!-- Max Tokens -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-2">
                    Max Response Length: <span id="tokenValue">1024</span> tokens
                </label>
                <input type="range" id="maxTokens" min="128" max="32768" step="128" value="1024"
                       class="w-full h-2 bg-black/30 rounded-lg appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-4 [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-red-500">
                <div class="flex justify-between mt-1">
                    <p class="text-gray-400 text-xs">Controls response length</p>
                    <p class="text-gray-400 text-xs">~<span id="wordEstimate">768</span> words</p>
                </div>
            </div>

            <!-- Token Counter Toggle -->
            <div>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="showTokenCounter" class="rounded">
                    <span class="text-gray-300 text-sm">Show token counter</span>
                </label>
            </div>

            <!-- Rate Limit Settings -->
            <div class="border-t border-white/10 pt-4">
                <h3 class="text-white font-bold mb-3">Rate Limiting</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-gray-300 text-sm mb-1">Requests per minute</label>
                        <input type="number" id="rateLimit" min="1" max="60" value="30" 
                               class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm">
                    </div>
                    <div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="enableRateLimit" checked class="rounded">
                            <span class="text-gray-300 text-sm">Enable rate limiting</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Chat History -->
            <div class="border-t border-white/10 pt-4">
                <h3 class="text-white font-bold mb-3">Chat History</h3>
                <div class="space-y-2">
                    <button onclick="clearHistory()" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-400 py-2 rounded-lg border border-red-500/30 transition-colors">
                        Clear History
                    </button>
                    <button onclick="exportHistory()" class="w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg border border-white/10 transition-colors">
                        Export Chat
                    </button>
                    <button onclick="importHistory()" class="w-full bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg border border-white/10 transition-colors">
                        Import Chat
                    </button>
                    <input type="file" id="importFile" accept=".json,.txt" class="hidden">
                </div>
            </div>

            <!-- Search Chat -->
            <div>
                <label class="block text-gray-300 text-sm font-bold mb-2">Search Chat</label>
                <input type="text" id="searchChat" placeholder="Search messages..."
                       class="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-white text-sm focus:outline-none focus:border-red-500/50">
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-white/10">
            <button onclick="saveSettings()" class="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white py-3 rounded-lg font-bold transition-all duration-200">
                SAVE SETTINGS
            </button>
        </div>
    </div>

    <div class="glass-panel w-full max-w-5xl h-[95vh] rounded-3xl flex flex-col relative overflow-hidden transition-all duration-300">
        
        <!-- Header -->
        <header class="p-5 border-b border-white/10 flex justify-between items-center bg-black/20 z-10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-600 to-red-900 flex items-center justify-center shadow-lg shadow-red-900/50">
                    <!-- Eye Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-white font-bold text-lg tracking-wider font-mono">NOTAM AI <span class="text-[10px] bg-red-500/20 text-red-400 px-1 rounded ml-1 border border-red-500/30" id="modelBadge">OPENROUTER</span></h1>
                    <p id="time-display" class="text-gray-400 text-xs font-mono mt-0.5">Initializing...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Token Toggle Button -->
                <button onclick="toggleTokenCounter()" id="tokenToggleBtn" class="text-white/60 hover:text-white transition-colors" title="Toggle Token Counter">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
                
                <!-- Settings Button -->
                <button onclick="openSettings()" class="text-white/60 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
                
                <!-- Install Button (Hidden by default) -->
                <button id="installBtn" class="hidden text-xs font-bold bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg border border-white/10 transition-colors flex items-center gap-2">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    INSTALL APP
                </button>
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-black/40 border border-white/5">
                    <div class="h-1.5 w-1.5 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444] animate-pulse"></div>
                    <span id="ip-display" class="text-white/40 text-[10px] font-mono tracking-widest">---.---.---.---</span>
                </div>
            </div>
        </header>

        <!-- Chat Area -->
        <div id="chat-window" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 chat-scroll relative">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="p-4 sm:p-6 bg-black/20 backdrop-blur-md border-t border-white/5 z-10">
            <div class="flex gap-3 bg-white/5 p-1.5 rounded-2xl border border-white/10 focus-within:border-red-500/50 focus-within:bg-white/10 transition-all duration-300 shadow-lg">
                <input type="text" id="userInput" 
                    placeholder="Enter command..." 
                    class="flex-1 bg-transparent border-none outline-none text-white px-4 py-3 placeholder:text-gray-500 font-medium"
                    autocomplete="off"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                    oninput="updateInputTokenCount()">
                
                <button onclick="sendMessage()" id="sendBtn"
                    class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white px-6 rounded-xl transition-all duration-200 font-bold active:scale-95 shadow-lg shadow-red-900/50 flex items-center justify-center group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="flex justify-between items-center mt-2">
                <div class="flex items-center gap-4">
                    <p class="text-[10px] text-gray-600 font-mono" id="providerDisplay">NOTAM AI v2.5 // OPENROUTER ACTIVE</p>
                    <div id="inputTokenCounter" class="text-[10px] text-gray-500 font-mono hidden">
                        Tokens: <span id="inputTokenCount">0</span>
                    </div>
                </div>
                <div id="rateLimitInfo" class="text-[10px] text-gray-400 font-mono">
                    <span id="requestCount">0</span>/<span id="rateLimitMax">30</span> requests/min
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG & STATE - OPENROUTER EDITION
        // ============================================
        // YOUR OPENROUTER API KEY
        const OPENROUTER_API_KEY = "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";
        // Your website URL (required for OpenRouter free credits)
        const OPENROUTER_REFERRER = "https://notam-ai.netlify.app"; // Change to your actual URL
        // ============================================
        
        const GROQ_API_KEY = "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";
        const CHAT_HISTORY_KEY = 'notam_chat_history';
        const SETTINGS_KEY = 'notam_settings';
        
        // API Providers
        const API_PROVIDERS = {
            OPENROUTER: 'openrouter',
            GROQ: 'groq'
        };
        
        // Available AI Models for each provider
        const OPENROUTER_MODELS = [
            {
                id: "openai/gpt-4o-mini",
                name: "GPT-4o Mini",
                provider: "OpenAI",
                description: "Fast and capable, OpenAI's best small model",
                maxTokens: 16384,
                badge: "OPENAI",
                costPerMTok: 0.15,
                recommended: true
            },
            {
                id: "meta-llama/llama-3.3-70b-instruct",
                name: "Llama 3.3 70B",
                provider: "Meta",
                description: "Most capable open-source model",
                maxTokens: 8192,
                badge: "POWER",
                costPerMTok: 0.59
            },
            {
                id: "google/gemma-2-9b-it",
                name: "Gemma 2 9B",
                provider: "Google",
                description: "Google's lightweight but capable model",
                maxTokens: 8192,
                badge: "GOOGLE",
                costPerMTok: 0.09,
                recommended: true
            },
            {
                id: "mistralai/mixtral-8x7b-instruct",
                name: "Mixtral 8x7B",
                provider: "Mistral",
                description: "Mixture of experts, excellent for coding",
                maxTokens: 32768,
                badge: "MISTRAL",
                costPerMTok: 0.24
            },
            {
                id: "deepseek/deepseek-chat",
                name: "DeepSeek Chat",
                provider: "DeepSeek",
                description: "Excellent coding and reasoning",
                maxTokens: 32768,
                badge: "DEEPSEEK",
                costPerMTok: 0.14
            },
            {
                id: "qwen/qwen-2.5-72b-instruct",
                name: "Qwen 2.5 72B",
                provider: "Alibaba",
                description: "Powerful Chinese/English model",
                maxTokens: 32768,
                badge: "QWEN",
                costPerMTok: 0.79
            }
        ];

        const GROQ_MODELS = [
            {
                id: "llama-3.3-70b-versatile",
                name: "Llama 3.3 70B",
                provider: "Groq",
                description: "Super fast Llama model (FREE)",
                maxTokens: 8192,
                badge: "SPEED",
                free: true
            },
            {
                id: "llama-3.2-90b-text-preview",
                name: "Llama 3.2 90B",
                provider: "Groq",
                description: "Extremely powerful for advanced reasoning",
                maxTokens: 8192,
                badge: "POWER",
                free: true
            },
            {
                id: "llama-3.1-8b-instant",
                name: "Llama 3.1 8B",
                provider: "Groq",
                description: "Fast and efficient for everyday tasks",
                maxTokens: 8192,
                badge: "FAST",
                free: true
            },
            {
                id: "openai/gpt-oss-120b",
                name: "GPT OSS 120B",
                provider: "Groq",
                description: "Massive 120B parameter open-source GPT",
                maxTokens: 8192,
                badge: "MASSIVE",
                free: true
            },
            {
                id: "qwen/qwen3-32b",
                name: "Qwen3 32B",
                provider: "Groq",
                description: "Powerful Qwen model, great for multilingual",
                maxTokens: 8192,
                badge: "QWEN",
                free: true
            },
            {
                id: "llama-3.2-3b-preview",
                name: "Llama 3.2 3B",
                provider: "Groq",
                description: "Ultra-fast for quick responses",
                maxTokens: 4096,
                badge: "ULTRA",
                free: true
            }
        ];
        
        // Preset Personas
        const PRESET_PERSONAS = [
            {
                id: "notam",
                name: "NOTAM Default",
                description: "High-performance, unfiltered intelligence",
                systemPrompt: "You are NOTAM AI. You are a high-performance, unfiltered-style intelligence. You speak directly, concisely, and efficiently. You do not use fluff words. You use bullet points and bold text for clarity. You are extremely helpful and knowledgeable. Warning: User is a minor, so strictly maintain safety protocols (no illegal acts, violence, or explicit content), but maintain the 'unfiltered' persona by being blunt and direct.",
                badge: "DEFAULT"
            },
            {
                id: "developer",
                name: "Senior Developer",
                description: "Expert programmer, loves clean code and best practices",
                systemPrompt: "You are a senior software engineer with 15+ years of experience. You provide expert programming advice, write clean, efficient code, and explain complex concepts clearly. You focus on best practices, performance optimization, and maintainable architecture. You're pragmatic but opinionated about good code. Use code examples and explain your reasoning.",
                badge: "CODE"
            },
            {
                id: "creative",
                name: "Creative Writer",
                description: "Imaginative storyteller and creative thinker",
                systemPrompt: "You are a creative writer and storyteller. You help with brainstorming, creative writing, story development, character creation, and imaginative thinking. You're eloquent, descriptive, and love exploring ideas. You write in a engaging, narrative style while staying helpful. Use metaphors, vivid descriptions, and creative analogies.",
                badge: "WRITE"
            },
            {
                id: "analyst",
                name: "Data Analyst",
                description: "Logical, data-driven problem solver",
                systemPrompt: "You are a data analyst and logical thinker. You approach problems systematically, use data to support conclusions, and explain things clearly with structured reasoning. You're precise, analytical, and focus on facts and evidence. Use bullet points, numbered lists, and clear hierarchies. Present information in a well-organized manner.",
                badge: "ANALYZE"
            },
            {
                id: "teacher",
                name: "Patient Teacher",
                description: "Explains complex topics simply and clearly",
                systemPrompt: "You are a patient, experienced teacher. You explain complex topics in simple terms, break down difficult concepts step by step, and ensure understanding. You're encouraging, supportive, and never condescending. Use analogies, examples, and check for understanding. Adapt your explanation based on the user's level of knowledge.",
                badge: "TEACH"
            },
            {
                id: "cyber",
                name: "Cybersecurity Expert",
                description: "Security-focused, technical expert",
                systemPrompt: "You are a cybersecurity expert. You provide security advice, explain vulnerabilities, and discuss best practices for digital security. You're technical, detail-oriented, and always emphasize security first. Warn about risks but also provide practical solutions. Use technical terms when appropriate but explain them clearly.",
                badge: "SECURE"
            },
            {
                id: "business",
                name: "Business Consultant",
                description: "Strategic thinker for business problems",
                systemPrompt: "You are a business consultant. You help with strategy, planning, problem-solving, and decision-making from a business perspective. You're professional, strategic, and focus on ROI and practical outcomes. Use frameworks, SWOT analysis, and business terminology. Be direct about risks and opportunities.",
                badge: "BIZ"
            },
            {
                id: "minimal",
                name: "Minimal Assistant",
                description: "Extremely concise, just the facts",
                systemPrompt: "You are a minimal AI assistant. You give the shortest possible answers that still contain all necessary information. No fluff, no explanations unless asked. Just pure information. Use bullet points, avoid complete sentences when possible. Maximum efficiency.",
                badge: "MIN"
            },
            {
                id: "therapist",
                name: "Supportive Listener",
                description: "Empathetic, supportive, and non-judgmental",
                systemPrompt: "You are a supportive, empathetic listener. You help users process thoughts and feelings, ask thoughtful questions, and provide emotional support without judgment. You're warm, understanding, and focus on helping users gain clarity. Never give medical advice - just support and perspective.",
                badge: "SUPPORT"
            },
            {
                id: "debate",
                name: "Debate Partner",
                description: "Challenges ideas, plays devil's advocate",
                systemPrompt: "You are a debate partner. You challenge ideas, ask probing questions, and play devil's advocate to help users think through their positions. You're logical, sometimes confrontational, but always respectful. Push back on weak arguments and demand evidence. Help strengthen reasoning through opposition.",
                badge: "DEBATE"
            }
        ];
        
        // Quick Personas (shorter versions for quick buttons)
        const QUICK_PERSONAS = [
            {
                id: "default",
                name: "Default",
                prompt: "You are NOTAM AI. You are a high-performance, unfiltered-style intelligence. You speak directly, concisely, and efficiently. You do not use fluff words. You use bullet points and bold text for clarity. You are extremely helpful and knowledgeable. Warning: User is a minor, so strictly maintain safety protocols (no illegal acts, violence, or explicit content), but maintain the 'unfiltered' persona by being blunt and direct."
            },
            {
                id: "coder",
                name: "Coder",
                prompt: "You are a senior software engineer. Write clean, efficient code with best practices. Explain technical concepts clearly. Focus on practical solutions and performance."
            },
            {
                id: "creative",
                name: "Creative",
                prompt: "You are a creative writer. Be imaginative, descriptive, and help with brainstorming. Use engaging language and explore ideas creatively."
            },
            {
                id: "analyst",
                name: "Analyst",
                prompt: "You are a data analyst. Be logical, systematic, and data-driven. Use bullet points and structured reasoning. Focus on facts and evidence."
            },
            {
                id: "teacher",
                name: "Teacher",
                prompt: "You are a patient teacher. Explain complex topics simply. Use analogies and examples. Check for understanding and adapt to user's level."
            },
            {
                id: "minimal",
                name: "Minimal",
                prompt: "You are a minimal assistant. Give the shortest possible answers with all necessary information. No fluff. Just facts. Maximum efficiency."
            }
        ];
        
        // Rate limiting
        let requestTimestamps = [];
        let settings = {
            systemPrompt: "You are NOTAM AI. You are a high-performance, unfiltered-style intelligence. You speak directly, concisely, and efficiently. You do not use fluff words. You use bullet points and bold text for clarity. You are extremely helpful and knowledgeable. Warning: User is a minor, so strictly maintain safety protocols (no illegal acts, violence, or explicit content), but maintain the 'unfiltered' persona by being blunt and direct.",
            temperature: 0.7,
            maxTokens: 1024,
            rateLimit: 30,
            enableRateLimit: true,
            selectedModel: "openai/gpt-4o-mini",
            selectedProvider: API_PROVIDERS.OPENROUTER,
            showTokenCounter: false,
            selectedPersona: "notam"
        };

        // --- 1. PWA & MANIFEST GENERATION ---
        function initPWA() {
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#0f172a"/><circle cx="256" cy="256" r="150" fill="#ef4444"/><circle cx="256" cy="256" r="80" fill="#ffffff"/></svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);

            const manifest = {
                name: "NOTAM AI",
                short_name: "NOTAM",
                start_url: ".",
                display: "standalone",
                background_color: "#0f172a",
                theme_color: "#0f172a",
                icons: [{ src: iconUrl, sizes: "512x512", type: "image/svg+xml" }]
            };
            
            const stringManifest = JSON.stringify(manifest);
            const blob = new Blob([stringManifest], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(blob);
            document.querySelector('#manifest-placeholder').setAttribute('href', manifestURL);
        }
        initPWA();

        // --- 2. INSTALL PROMPT LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('installBtn');
            installBtn.classList.remove('hidden');
            
            installBtn.addEventListener('click', () => {
                installBtn.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            });
        });

        // --- 3. SETTINGS MANAGEMENT ---
        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const loadedSettings = JSON.parse(saved);
                settings = { ...settings, ...loadedSettings };
                
                // Update UI
                document.getElementById('systemPrompt').value = settings.systemPrompt;
                document.getElementById('temperature').value = settings.temperature;
                document.getElementById('tempValue').textContent = settings.temperature;
                document.getElementById('maxTokens').value = settings.maxTokens;
                document.getElementById('tokenValue').textContent = settings.maxTokens;
                document.getElementById('rateLimit').value = settings.rateLimit;
                document.getElementById('enableRateLimit').checked = settings.enableRateLimit;
                document.getElementById('showTokenCounter').checked = settings.showTokenCounter;
                
                // Update provider selection
                updateProviderUI();
                loadModelSelection();
                loadPersonaSelection();
                loadQuickPersonas();
                updateModelBadge();
                
                // Update token counter visibility
                if (settings.showTokenCounter) {
                    document.getElementById('tokenCounter').classList.add('active');
                }
                
                updateRateLimitDisplay();
                updateWordEstimate();
                updateTokenCount();
            }
        }

        function saveSettings() {
            settings.systemPrompt = document.getElementById('systemPrompt').value;
            settings.temperature = parseFloat(document.getElementById('temperature').value);
            settings.maxTokens = parseInt(document.getElementById('maxTokens').value);
            settings.rateLimit = parseInt(document.getElementById('rateLimit').value);
            settings.enableRateLimit = document.getElementById('enableRateLimit').checked;
            settings.showTokenCounter = document.getElementById('showTokenCounter').checked;
            
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            closeSettings();
            updateRateLimitDisplay();
            updateWordEstimate();
            updateTokenCount();
            
            if (settings.showTokenCounter) {
                document.getElementById('tokenCounter').classList.add('active');
            } else {
                document.getElementById('tokenCounter').classList.remove('active');
            }
            
            showNotification('Settings saved successfully');
        }

        function openSettings() {
            document.getElementById('settingsPanel').classList.add('active');
            document.getElementById('settingsOverlay').classList.add('active');
            loadModelSelection();
            loadPersonaSelection();
            loadQuickPersonas();
            updateTokenCount();
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('active');
            document.getElementById('settingsOverlay').classList.remove('active');
        }

        // --- 4. API PROVIDER SELECTION ---
        function updateProviderUI() {
            const isOpenRouter = settings.selectedProvider === API_PROVIDERS.OPENROUTER;
            
            // Update button styles
            document.getElementById('providerOpenRouter').className = 
                `px-4 py-2 rounded-lg font-bold text-sm ${isOpenRouter ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-white/10 text-white border border-white/10'}`;
            document.getElementById('providerGroq').className = 
                `px-4 py-2 rounded-lg font-bold text-sm ${!isOpenRouter ? 'bg-red-500/20 text-red-400 border border-red-500/30' : 'bg-white/10 text-white border border-white/10'}`;
            
            // Update API status
            const apiStatus = document.getElementById('apiStatus');
            if (isOpenRouter) {
                apiStatus.innerHTML = '<div class="h-1.5 w-1.5 rounded-full bg-green-500"></div><span>OpenRouter: Connected</span>';
                apiStatus.className = 'api-status';
                document.getElementById('providerDisplay').textContent = 'NOTAM AI v2.5 // OPENROUTER ACTIVE';
            } else {
                apiStatus.innerHTML = '<div class="h-1.5 w-1.5 rounded-full bg-green-500"></div><span>Groq: Connected (FREE)</span>';
                apiStatus.className = 'api-status';
                document.getElementById('providerDisplay').textContent = 'NOTAM AI v2.5 // GROQ ACTIVE (FREE)';
            }
            
            // Update model badge
            updateModelBadge();
        }

        document.getElementById('providerOpenRouter').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.OPENROUTER;
            // Default to GPT-4o Mini when switching to OpenRouter
            settings.selectedModel = "openai/gpt-4o-mini";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to OpenRouter API');
        };

        document.getElementById('providerGroq').onclick = () => {
            settings.selectedProvider = API_PROVIDERS.GROQ;
            // Default to Llama 3.3 when switching to Groq
            settings.selectedModel = "llama-3.3-70b-versatile";
            updateProviderUI();
            loadModelSelection();
            showNotification('Switched to Groq API (FREE)');
        };

        // --- 5. AI MODEL SELECTION ---
        function loadModelSelection() {
            const container = document.getElementById('modelSelection');
            container.innerHTML = '';
            
            const models = settings.selectedProvider === API_PROVIDERS.OPENROUTER ? OPENROUTER_MODELS : GROQ_MODELS;
            
            models.forEach(model => {
                const div = document.createElement('div');
                div.className = `model-select ${model.id === settings.selectedModel ? 'selected' : ''}`;
                div.onclick = () => selectModel(model.id);
                
                const isFree = settings.selectedProvider === API_PROVIDERS.GROQ || (model.costPerMTok && model.costPerMTok < 0.2);
                const costText = settings.selectedProvider === API_PROVIDERS.GROQ ? 
                    'FREE' : 
                    `$${model.costPerMTok}/MTok`;
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-white">${model.name}</div>
                            <div class="text-xs text-gray-400 mt-1">${model.provider} • ${model.description}</div>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <span class="model-badge">${model.badge}</span>
                            <span class="text-[10px] ${isFree ? 'text-green-400 bg-green-900/20' : 'text-yellow-400 bg-yellow-900/20'} px-1 rounded">${costText}</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2">
                        Max tokens: ${model.maxTokens.toLocaleString()}
                        ${model.recommended ? '<span class="ml-2 text-green-400">✓ Recommended</span>' : ''}
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function selectModel(modelId) {
            settings.selectedModel = modelId;
            
            // Update model badge in header
            updateModelBadge();
            
            // Get current model to update max tokens
            const models = settings.selectedProvider === API_PROVIDERS.OPENROUTER ? OPENROUTER_MODELS : GROQ_MODELS;
            const selectedModel = models.find(m => m.id === modelId);
            
            if (selectedModel) {
                // Update max tokens slider if current value exceeds model limit
                if (settings.maxTokens > selectedModel.maxTokens) {
                    settings.maxTokens = selectedModel.maxTokens;
                    document.getElementById('maxTokens').value = selectedModel.maxTokens;
                    document.getElementById('maxTokens').max = selectedModel.maxTokens;
                    document.getElementById('tokenValue').textContent = selectedModel.maxTokens;
                    updateWordEstimate();
                    updateTokenCount();
                } else {
                    // Still update the max attribute
                    document.getElementById('maxTokens').max = selectedModel.maxTokens;
                }
                
                // Show notification
                showNotification(`Switched to ${selectedModel.name} (${selectedModel.provider})`);
            }
            
            // Re-render model selection
            loadModelSelection();
        }

        function updateModelBadge() {
            const models = settings.selectedProvider === API_PROVIDERS.OPENROUTER ? OPENROUTER_MODELS : GROQ_MODELS;
            const selectedModel = models.find(m => m.id === settings.selectedModel);
            
            if (selectedModel) {
                document.getElementById('modelBadge').textContent = selectedModel.badge;
            } else {
                document.getElementById('modelBadge').textContent = 
                    settings.selectedProvider === API_PROVIDERS.OPENROUTER ? 'OPENROUTER' : 'GROQ';
            }
        }

        // --- 6. PERSONA MANAGEMENT ---
        function loadPersonaSelection() {
            const container = document.getElementById('presetPersonas');
            container.innerHTML = '';
            
            PRESET_PERSONAS.forEach(persona => {
                const div = document.createElement('div');
                div.className = `persona-select ${persona.id === settings.selectedPersona ? 'selected' : ''}`;
                div.onclick = () => selectPersona(persona.id);
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-white">${persona.name}</div>
                            <div class="text-xs text-gray-400 mt-1">${persona.description}</div>
                        </div>
                        <span class="persona-badge">${persona.badge}</span>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function loadQuickPersonas() {
            const container = document.getElementById('quickPersonas');
            container.innerHTML = '';
            
            QUICK_PERSONAS.forEach(persona => {
                const button = document.createElement('button');
                button.className = 'quick-persona-btn';
                button.textContent = persona.name;
                button.title = persona.prompt.substring(0, 100) + '...';
                button.onclick = () => applyQuickPersona(persona.id);
                
                container.appendChild(button);
            });
        }

        function selectPersona(personaId) {
            const persona = PRESET_PERSONAS.find(p => p.id === personaId);
            if (!persona) return;
            
            settings.selectedPersona = personaId;
            settings.systemPrompt = persona.systemPrompt;
            
            // Update UI
            document.getElementById('systemPrompt').value = persona.systemPrompt;
            
            // Update quick persona buttons
            document.querySelectorAll('.quick-persona-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Re-render persona selection
            loadPersonaSelection();
            
            // Update token count
            updateTokenCount();
            
            showNotification(`Applied ${persona.name} persona`);
        }

        function applyQuickPersona(personaId) {
            const persona = QUICK_PERSONAS.find(p => p.id === personaId);
            if (!persona) return;
            
            settings.systemPrompt = persona.prompt;
            settings.selectedPersona = "custom"; // Mark as custom since it's not a full preset
            
            // Update UI
            document.getElementById('systemPrompt').value = persona.prompt;
            
            // Update quick persona buttons
            document.querySelectorAll('.quick-persona-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === persona.name) {
                    btn.classList.add('active');
                }
            });
            
            // Update token count
            updateTokenCount();
            
            showNotification(`Applied ${persona.name} persona`);
        }

        // --- 7. RATE LIMITING ---
        function canMakeRequest() {
            if (!settings.enableRateLimit) return true;
            
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            
            // Remove old timestamps
            requestTimestamps = requestTimestamps.filter(time => time > oneMinuteAgo);
            
            if (requestTimestamps.length >= settings.rateLimit) {
                return false;
            }
            
            requestTimestamps.push(now);
            updateRateLimitDisplay();
            return true;
        }

        function updateRateLimitDisplay() {
            const now = Date.now();
            const oneMinuteAgo = now - 60000;
            requestTimestamps = requestTimestamps.filter(time => time > oneMinuteAgo);
            
            document.getElementById('requestCount').textContent = requestTimestamps.length;
            document.getElementById('rateLimitMax').textContent = settings.rateLimit;
            
            if (requestTimestamps.length >= settings.rateLimit * 0.8) {
                document.getElementById('rateLimitInfo').classList.add('text-red-400');
            } else {
                document.getElementById('rateLimitInfo').classList.remove('text-red-400');
            }
        }

        // --- 8. TOKEN COUNTING ---
        function estimateTokens(text) {
            if (!text || text.trim() === '') return 0;
            
            const cleaned = text.trim().replace(/\s+/g, ' ');
            const chars = cleaned.length;
            const words = cleaned.split(' ').length;
            
            const charEstimate = Math.ceil(chars / 4);
            const wordEstimate = Math.ceil(words * 1.3);
            
            return Math.ceil((charEstimate + wordEstimate * 1.2) / 2.2);
        }

        function updateTokenCount() {
            const prompt = document.getElementById('systemPrompt').value;
            const tokens = estimateTokens(prompt);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            document.getElementById('promptTokens').textContent = tokens;
            
            if (settings.showTokenCounter) {
                updateTokenCounter(tokens, maxTokens);
            }
        }

        function updateInputTokenCount() {
            const input = document.getElementById('userInput').value;
            const tokens = estimateTokens(input);
            
            document.getElementById('inputTokenCount').textContent = tokens;
            
            if (tokens > 0) {
                document.getElementById('inputTokenCounter').classList.remove('hidden');
                
                if (tokens > 1000) {
                    document.getElementById('inputTokenCounter').classList.add('text-red-400');
                } else {
                    document.getElementById('inputTokenCounter').classList.remove('text-red-400');
                }
            } else {
                document.getElementById('inputTokenCounter').classList.add('hidden');
            }
        }

        function updateTokenCounter(currentTokens, maxTokens) {
            const tokenCount = document.getElementById('tokenCount');
            const progressBar = document.getElementById('tokenProgressBar');
            const estimate = document.getElementById('tokenEstimate');
            
            const percentage = Math.min((currentTokens / maxTokens) * 100, 100);
            progressBar.style.width = `${percentage}%`;
            tokenCount.textContent = `${currentTokens}/${maxTokens}`;
            
            if (percentage > 90) {
                tokenCount.classList.add('token-warning');
                progressBar.style.background = '#ef4444';
            } else if (percentage > 70) {
                tokenCount.classList.remove('token-warning');
                progressBar.style.background = '#f59e0b';
            } else {
                tokenCount.classList.remove('token-warning');
                progressBar.style.background = 'linear-gradient(90deg, #10b981, #3b82f6)';
            }
            
            const words = Math.floor(currentTokens / 1.3);
            estimate.textContent = `~${words.toLocaleString()} words`;
        }

        function toggleTokenCounter() {
            settings.showTokenCounter = !settings.showTokenCounter;
            document.getElementById('showTokenCounter').checked = settings.showTokenCounter;
            
            if (settings.showTokenCounter) {
                document.getElementById('tokenCounter').classList.add('active');
                updateTokenCount();
            } else {
                document.getElementById('tokenCounter').classList.remove('active');
            }
            
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const currentSettings = JSON.parse(saved);
                currentSettings.showTokenCounter = settings.showTokenCounter;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
            }
        }

        function updateWordEstimate() {
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const words = Math.floor(maxTokens / 1.3);
            document.getElementById('wordEstimate').textContent = words.toLocaleString();
            
            if (settings.showTokenCounter) {
                const currentTokens = estimateTokens(document.getElementById('systemPrompt').value);
                updateTokenCounter(currentTokens, maxTokens);
            }
        }

        // --- 9. CHAT HISTORY & PERSISTENCE ---
        function saveMessage(role, content) {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            history.push({
                role,
                content,
                timestamp: new Date().toISOString(),
                model: settings.selectedModel,
                provider: settings.selectedProvider,
                persona: settings.selectedPersona
            });
            if (history.length > 100) history.splice(0, history.length - 100);
            localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            history.forEach(msg => {
                if (msg.role === 'system') return;
                appendMessage(msg.content, msg.role);
            });
        }

        function clearHistory() {
            if (confirm('Clear all chat history?')) {
                localStorage.removeItem(CHAT_HISTORY_KEY);
                document.getElementById('chat-window').innerHTML = '';
                showNotification('Chat history cleared');
            }
        }

        function exportHistory() {
            const history = JSON.parse(localStorage.getItem(CHAT_HISTORY_KEY) || '[]');
            const dataStr = JSON.stringify(history, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `notam-chat-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            showNotification('Chat exported successfully');
        }

        function importHistory() {
            document.getElementById('importFile').click();
        }

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const history = JSON.parse(e.target.result);
                    localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(history));
                    document.getElementById('chat-window').innerHTML = '';
                    loadChatHistory();
                    showNotification('Chat imported successfully');
                } catch (error) {
                    showNotification('Error importing chat file', true);
                }
            };
            reader.readAsText(file);
        });

        // --- 10. SEARCH FUNCTIONALITY ---
        document.getElementById('searchChat').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const messages = document.querySelectorAll('.content');
            
            document.querySelectorAll('.search-highlight').forEach(el => {
                el.outerHTML = el.innerHTML;
            });
            
            if (term.length < 2) return;
            
            messages.forEach(msg => {
                const content = msg.textContent.toLowerCase();
                const messageDiv = msg.closest('.flex');
                
                if (content.includes(term)) {
                    messageDiv.style.display = 'flex';
                    const html = msg.innerHTML.replace(
                        new RegExp(term, 'gi'),
                        match => `<span class="search-highlight">${match}</span>`
                    );
                    msg.innerHTML = html;
                } else if (term.length >= 2) {
                    messageDiv.style.display = 'none';
                } else {
                    messageDiv.style.display = 'flex';
                }
            });
        });

        // --- 11. CORE LOGIC ---
        function updateTime() {
            const now = new Date();
            document.getElementById('time-display').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateTime, 1000);

        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return "Good morning.";
            if (hour < 18) return "Good afternoon.";
            return "Good evening.";
        }

        async function initSystem() {
            updateTime();
            loadSettings();
            
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                document.getElementById('ip-display').innerText = ipData.ip;
            } catch(e) { /* ignore */ }

            loadChatHistory();

            if (!localStorage.getItem(CHAT_HISTORY_KEY)) {
                const greeting = getGreeting();
                appendMessage(`${greeting} NOTAM AI online. OpenRouter API connected. 10 preset personas available. Awaiting your input.`, 'ai');
            }
            
            updateTokenCount();
            updateProviderUI();
            loadQuickPersonas();
        }

        initSystem();

        // --- 12. CHAT LOGIC WITH OPENROUTER SUPPORT ---
        async function sendMessage() {
            if (!canMakeRequest()) {
                showRateLimitWarning();
                return;
            }

            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const text = input.value.trim();

            if (!text) return;

            // User Message
            appendMessage(text, 'user');
            saveMessage('user', text);
            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');
            
            document.getElementById('inputTokenCounter').classList.add('hidden');

            // AI Message Placeholder
            const aiMsgDiv = createMessageDiv('ai');
            const contentDiv = aiMsgDiv.querySelector('.content');
            let fullContent = "";

            // Add typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            contentDiv.appendChild(typingIndicator);

            try {
                let apiUrl, headers, body;
                
                if (settings.selectedProvider === API_PROVIDERS.OPENROUTER) {
                    // OpenRouter API
                    apiUrl = "https://openrouter.ai/api/v1/chat/completions";
                    headers = {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": OPENROUTER_REFERRER,
                        "X-Title": "NOTAM AI"
                    };
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        temperature: settings.temperature,
                        max_tokens: settings.maxTokens,
                        stream: true
                    };
                } else {
                    // Groq API
                    apiUrl = "https://api.groq.com/openai/v1/chat/completions";
                    headers = {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    };
                    body = {
                        model: settings.selectedModel,
                        messages: [
                            { 
                                role: "system", 
                                content: settings.systemPrompt
                            },
                            { role: "user", content: text }
                        ],
                        temperature: settings.temperature,
                        max_tokens: settings.maxTokens,
                        stream: true
                    };
                }

                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText}`);
                }

                typingIndicator.remove();

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split("\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ") && line !== "data: [DONE]") {
                            try {
                                const jsonData = JSON.parse(line.substring(6));
                                const content = jsonData.choices[0].delta.content || "";
                                fullContent += content;
                                contentDiv.innerHTML = marked.parse(fullContent);
                                
                                contentDiv.querySelectorAll('pre code').forEach(block => {
                                    hljs.highlightElement(block);
                                });
                                
                                contentDiv.querySelectorAll('pre').forEach(pre => {
                                    if (!pre.parentElement.classList.contains('code-block')) {
                                        const codeBlock = document.createElement('div');
                                        codeBlock.className = 'code-block';
                                        
                                        const header = document.createElement('div');
                                        header.className = 'code-header';
                                        header.innerHTML = `
                                            <span>Code</span>
                                            <button class="code-copy-btn" onclick="copyCode(this)">Copy</button>
                                        `;
                                        
                                        const contentDiv = document.createElement('div');
                                        contentDiv.className = 'code-content';
                                        contentDiv.appendChild(pre.cloneNode(true));
                                        
                                        codeBlock.appendChild(header);
                                        codeBlock.appendChild(contentDiv);
                                        
                                        pre.replaceWith(codeBlock);
                                    }
                                });
                                
                                document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                            } catch (e) {
                                // Skip parsing errors
                            }
                        }
                    }
                }

                saveMessage('ai', fullContent);

            } catch (error) {
                typingIndicator.remove();
                console.error('API Error:', error);
                contentDiv.innerText = `API ERROR: ${error.message}. Try switching API provider or model.`;
                saveMessage('ai', `API ERROR: ${error.message}`);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
                input.focus();
                updateRateLimitDisplay();
            }
        }

        // --- 13. UI HELPERS ---
        function createMessageDiv(sender) {
            const chatWindow = document.getElementById('chat-window');
            const wrapper = document.createElement('div');
            wrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-anim`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const div = document.createElement('div');
            div.className = `${sender === 'user' ? 'user-message' : 'ai-message'} p-4 rounded-2xl max-w-[85%] text-sm leading-relaxed shadow-xl relative group`;
            
            const content = document.createElement('div');
            content.className = 'content';
            div.appendChild(content);

            const footer = document.createElement('div');
            footer.className = 'flex items-center justify-between mt-2 pt-2 border-t border-white/10 text-[10px] text-white/40 font-mono gap-4';
            
            const timeSpan = document.createElement('span');
            timeSpan.innerText = time;
            footer.appendChild(timeSpan);

            if (sender === 'ai') {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn text-white/60 hover:text-white transition-colors uppercase tracking-wider font-bold cursor-pointer flex items-center gap-1';
                copyBtn.innerHTML = `<span>COPY</span> <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                copyBtn.onclick = () => {
                    const textToCopy = div.querySelector('.content').innerText;
                    navigator.clipboard.writeText(textToCopy);
                    copyBtn.innerHTML = `<span class="text-green-400">COPIED</span>`;
                    setTimeout(() => {
                        copyBtn.innerHTML = `<span>COPY</span> <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                    }, 2000);
                };
                footer.appendChild(copyBtn);
            }

            div.appendChild(footer);
            wrapper.appendChild(div);
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return div;
        }

        function appendMessage(text, sender) {
            const div = createMessageDiv(sender);
            const contentDiv = div.querySelector('.content');
            contentDiv.innerHTML = marked.parse(text);
            
            contentDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
            
            contentDiv.querySelectorAll('pre').forEach(pre => {
                if (!pre.parentElement.classList.contains('code-block')) {
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `
                        <span>Code</span>
                        <button class="code-copy-btn" onclick="copyCode(this)">Copy</button>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'code-content';
                    contentDiv.appendChild(pre.cloneNode(true));
                    
                    codeBlock.appendChild(header);
                    codeBlock.appendChild(contentDiv);
                    
                    pre.replaceWith(codeBlock);
                }
            });
        }

        function showRateLimitWarning() {
            const warning = document.createElement('div');
            warning.className = 'rate-limit-warning';
            warning.innerHTML = `Rate limit exceeded. Maximum ${settings.rateLimit} requests per minute.`;
            
            const chatWindow = document.getElementById('chat-window');
            chatWindow.appendChild(warning);
            
            setTimeout(() => warning.remove(), 5000);
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border ${isError ? 'bg-red-500/20 border-red-500/30 text-red-400' : 'bg-green-500/20 border-green-500/30 text-green-400'} text-sm font-mono z-50`;
            notification.style.animation = 'slideUpFade 0.3s';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function copyCode(button) {
            const codeBlock = button.closest('.code-block');
            const codeElement = codeBlock.querySelector('code');
            const codeText = codeElement.textContent;
            
            navigator.clipboard.writeText(codeText);
            button.textContent = 'Copied!';
            button.classList.add('text-green-400');
            
            setTimeout(() => {
                button.textContent = 'Copy';
                button.classList.remove('text-green-400');
            }, 2000);
        }

        // --- 14. SETTINGS UI UPDATES ---
        document.getElementById('temperature').addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
        });

        document.getElementById('maxTokens').addEventListener('input', function() {
            const value = parseInt(this.value);
            document.getElementById('tokenValue').textContent = value;
            updateWordEstimate();
            updateTokenCount();
        });

        document.getElementById('userInput').addEventListener('input', updateInputTokenCount);

        // Initialize
        setInterval(updateRateLimitDisplay, 5000);
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
